R"htmljs(
(()=>{var N=class{constructor(t){this.canvas=t;var e=this.context=t.getContext("2d");this.width=t.width,this.height=t.height;let s=window.devicePixelRatio||1,i=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,h=s/i;if(s!==i){let r=this.width,o=this.height;this.width=t.width=r*h,this.height=t.height=o*h,t.style.width=r+"px",t.style.height=o+"px",e.scale(h,h)}}};var L=class{constructor(t){this._dc=t,this._mouseButtonDown=!1,this._lastMouseCoords=null}mouseDown(t){this._mouseButtonDown=!0,this._lastMouseCoords=t}mouseMove(t){}mouseUp(t){this._mouseButtonDown=!1,this._lastMouseCoords=null}};var w=class extends L{#t;#e;#n;#s;constructor(t){super(t),this.#t=null}mouseDown(t){if(super.mouseDown(t),this.#t=this._dc.adorners.getAdornerHandleAtCoords(t),this.#t){this.#t.startDrag();return}var e=this._dc.activeLayer?.hitTest(t.xTrans,t.yTrans);if(this._dc.shapeIsSelected(e)){t.shiftKey==!0&&(this.#e=e,this.#n=t),this._dc.startDragSelectedShapes();return}e?(t.shiftKey==!1&&this._dc.deselectAllShapes(),e.selected=!0,this._dc.selectShape(e)):t.shiftKey==!1&&(this._dc.deselectAllShapes(),this.#s={x:t.xTrans,y:t.yTrans,width:0,height:0},this._dc.selectionRect={x:t.x,y:t.y,width:0,height:0})}mouseMove(t){if(this._mouseButtonDown&&this.#s){this.#s.width=t.xTrans-this.#s.x,this.#s.height=t.yTrans-this.#s.y,this._dc.selectionRect.width=t.x-this._dc.selectionRect.x,this._dc.selectionRect.height=t.y-this._dc.selectionRect.y;return}if(this._mouseButtonDown&&this._dc.selectedShapes.length){var e={x:t.xTrans-this._lastMouseCoords.xTrans,y:t.yTrans-this._lastMouseCoords.yTrans};this.#t?(this.#t.drag(e,t,this._dc.snapToGrid?this._dc.grid:null),this._dc.adorners.updateHandles(),this._dc.updated()):this._dc.moveSelectedShapesBy(e,this._dc.snapToGrid?this._dc.grid:null),this._lastMouseCoords=t}}mouseUp(t){if(super.mouseUp(t),this.#t=null,this.#e){Math.abs(this.#n.xTrans-t.xTrans)<3&&Math.abs(this.#n.yTrans-t.yTrans)<3&&this._dc.deselectShape(this.#e),this.#e=null;return}if(this.#s){let e={x:this.#s.x,y:this.#s.y,width:Math.abs(this.#s.width),height:Math.abs(this.#s.height)};this.#s.width<0&&(e.x=this.#s.x+this.#s.width),this.#s.height<0&&(e.y=this.#s.y+this.#s.height),this.#s.width>2&&this.#s.height>2&&this._dc.selectShapesInRect(e),this.#s=null,this._dc.selectionRect=null}}};var T=class{#t;#e;#n;#s;#h;constructor(t,e,s,i,h,r){this.x=t,this.y=e,this.#e=s,this.#n=i,this.#s=h,this.#h=r,this.selected=!1}get stroke(){return this.#e}set stroke(t){this.#e&&(this.#e=t)}get strokeThickness(){return this.#n}set strokeThickness(t){this.#n&&(this.#n=t)}get strokeType(){return this.#s}set strokeType(t){this.#s&&(this.#s=t)}get strokeRoughness(){return this.#h}set strokeRoughness(t){this.#h&&(this.#h=t)}draw(t){}startDrag(){this.#t={x:this.x,y:this.y}}moveBy(t,e){if(this.#t||(this.#t={x:this.x,y:this.y}),this.#t.x+=t.x,this.#t.y+=t.y,e){var s=S([this.#t.x,this.#t.y],e);this.x=s[0],this.y=s[1]}else this.x+=t.x,this.y+=t.y}breakApart(){return[]}_setStrokeStyle(t){this.stroke&&(t.strokeStyle=this.stroke);let e=this.strokeThickness;e&&(t.lineWidth=e,this.strokeType&&t.setLineDash(this.strokeType==="Dashed"?[e*3,e*3]:this.strokeType==="Dotted"?[e,e]:[]))}serialize(){return{type:this.type,data:JSON.stringify(this.getDataObject())}}};var M=class{constructor(t,e,s){this._shape=t,this._zoomLevel=e||1,this._offset=s||{x:0,y:0},this._actualHandles=[]}get zoomLevel(){return this._zoomLevel}set zoomLevel(t){this._zoomLevel=t,this.updateHandles()}get offset(){return this._offset}set offset(t){this._offset=t,this.updateHandles()}draw(t){t.fillStyle="#cccccc",t.strokeStyle="#444444";for(var e=0;e<this._actualHandles.length;e++)this._actualHandles[e].draw(t)}updateHandles(){for(var t=0;t<this._actualHandles.length;t++)this._actualHandles[t].updatePosition(this.zoomLevel,this.offset)}};var O=class{constructor(t,e){this._shape=t,this._movement=e,this._origin={x:0,y:0}}hitTest(t){var e=this._actualHandleRect;return t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<=e.y+e.height}_drawSquareHandle(t,e){t.fillRect(e.x,e.y,e.width,e.height),t.strokeRect(e.x,e.y,e.width,e.height)}_getHandleRect(t){return{x:t.x-5,y:t.y-5,width:5*2,height:5*2,cX:t.x,cY:t.y}}},X=class extends O{#t;#e;constructor(t,e,s){super(t,e,s),this.updatePosition(s)}startDrag(){this.#t={x:this._shape.x,y:this._shape.y}}drag(t,e,s){if(this.#t.x+=t.x,this.#t.y+=t.y,s){let r=S([this.#t.x,this.#t.y],s);t.x=r[0]-this.#e.x,t.y=r[1]-this.#e.y}t=C(t,this._origin,-this._shape.angle),t.x*=Math.sqrt(Math.pow(this._movement.x,2)),t.y*=Math.sqrt(Math.pow(this._movement.y,2));let i={x:t.x/2,y:t.y/2},h=C(i,this._origin,this._shape.angle);h.x+=i.x*(this._movement.x*-1),h.y+=i.y*(this._movement.y*-1),this._shape.moveBy(h),this._shape.scaleBy({x:t.x*this._movement.x,y:t.y*this._movement.y}),this.updatePosition(this._zoomLevel)}draw(t){this._drawSquareHandle(t,this._relativeHandleRect)}updatePosition(t){this.#e={x:this._shape.x+this._shape.width/2+this._movement.x*this._shape.width/2,y:this._shape.y+this._shape.height/2+this._movement.y*this._shape.height/2};let e={x:this._movement.x*this._shape.width/2*t,y:this._movement.y*this._shape.height/2*t};this._actualHandleRect=this._getHandleRect(this.#e),this._relativeHandleRect=this._getHandleRect(e)}},j=class extends O{constructor(t,e){super(t,{x:0,y:0},e),this.updatePosition(e)}drag(t,e){let s={x:e.xTrans-(this._shape.x+this._shape.width/2),y:e.yTrans-(this._shape.y+this._shape.height/2)},i=Math.atan2(s.y,s.x);this._shape.angle=i*180/Math.PI+90}draw(t){t.beginPath(),t.arc(this._relativePosition.x,this._relativePosition.y,5,0,Math.PI*2,!0),t.closePath(),t.fill(),t.stroke()}updatePosition(t){let e={x:this._shape.x+this._shape.width/2,y:this._shape.y-30/t};this._relativePosition={x:0,y:-this._shape.height/2*t-30},this._actualHandleRect=this._getHandleRect(e)}},v=class extends O{#t;#e;constructor(t,e,s){super(t,{x:0,y:0},e),this.center={x:0,y:0},this.updatePosition(e,s)}startDrag(){this.#t={x:this._shape.x,y:this._shape.y}}drag(t,e,s){if(s){this.#t.x+=t.x,this.#t.y+=t.y;var i=S([this.#t.x,this.#t.y],s);this._shape.x=i[0],this._shape.y=i[1]}else this._shape.x+=t.x,this._shape.y+=t.y;this.linkedPoint&&(this.linkedPoint.x=this._shape.x,this.linkedPoint.y=this._shape.y)}draw(t){this._drawSquareHandle(t,this._actualHandleRect)}updatePosition(t,e){this.#e={x:this._shape.x*t+e.x,y:this._shape.y*t+e.y},this._actualHandleRect=this._getHandleRect(this.#e),this.center={x:this.#e.x,y:this.#e.y}}};var D=class extends M{#t;#e;constructor(t,e,s){super(t,e,s),this.#e=[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0}],this.#t={x:0,y:0},this.drawBoundingBox=!1;for(let i=0;i<this.#e.length;i++)this._actualHandles.push(new X(this._shape,this.#e[i],e,this));this._shape.rotatable&&this._actualHandles.push(new j(this._shape,e)),this.updateHandles()}draw(t){t.save(),t.translate(this.#t.x,this.#t.y),this._shape.angle&&t.rotate(this._shape.angle*Math.PI/180),this.drawBoundingBox&&(t.strokeStyle="#666666",t.setLineDash([3,3]),t.lineWidth=1,t.strokeRect(-this._shape.width/2,-this._shape.height/2,this._shape.width,this._shape.height),t.setLineDash([])),super.draw(t),t.restore()}getHandleAtCoords(t){let e=C(t,this.#t,-this._shape.angle),s={x:(e.x-this.offset.x)/this.zoomLevel,y:(e.y-this.offset.y)/this.zoomLevel};for(var i=0;i<this._actualHandles.length;i++)if(this._actualHandles[i].hitTest(s))return this._actualHandles[i];return!1}updateHandles(){super.updateHandles(),this.#t={x:this._offset.x+(this._shape.x+this._shape.width/2)*this.zoomLevel,y:this._offset.y+(this._shape.y+this._shape.height/2)*this.zoomLevel}}};var k=class extends T{constructor(t,e,s,i,h,r,o,a,d){super(t,e,r,o,a,d),this.width=s,this.height=i,this.angle=h,this.handleMovements=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}]}getAdorner(){return new D(this)}hitTest(t,e){var s=C({x:t,y:e},{x:this.x+this.width/2,y:this.y+this.height/2},-this.angle);return s.x>=this.x&&s.x<=this.x+this.width&&s.y>=this.y&&s.y<=this.y+this.height}scaleBy(t){this.width+=t.x,this.height+=t.y}getExtents(){return{x:this.x,y:this.y,width:this.width,height:this.height}}getDataObject(){return{x:this.x,y:this.y,width:this.width,height:this.height,angle:this.angle,rotatable:!0}}_trasformContext(t){t.save(),t.translate(this.x+this.width/2,this.y+this.height/2),this.angle&&t.rotate(this.angle*Math.PI/180)}};var z=class extends M{getHandleAtCoords(t){for(var e=0;e<this._actualHandles.length;e++)if(this._actualHandles[e].hitTest({x:t.x,y:t.y}))return this._actualHandles[e];return!1}};var q=class extends z{constructor(t,e,s){super(t,e,s),this._actualHandles.push(new v(t.startPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endPoint,this.zoomLevel,this.offset)),this.updateHandles()}};var g=class n extends T{constructor(t,e,s,i,h,r,o,a){r=r??2,a=a??1,super(t,e,h||"#000",r,o||"Solid",a),this.startPoint={x:t,y:e},this.endPoint={x:s,y:i},this.type="Line"}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e,this.endPoint.x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e,this.endPoint.y+=e}getAdorner(){return new q(this)}draw(t){this._setStrokeStyle(t),t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y),t.lineCap="round",t.lineTo(this.endPoint.x,this.endPoint.y),t.stroke()}hitTest(t,e){let s,i,h=this.strokeThickness>4?this.strokeThickness:4;if(this.startPoint.x<=this.endPoint.x?(s=this.startPoint,i=this.endPoint):(i=this.startPoint,s=this.endPoint),t+h<s.x||i.x<t-h||e+h<Math.min(s.y,i.y)||Math.max(s.y,i.y)<e-h)return!1;let r={x:i.x-s.x,y:i.y-s.y};if(r.x==0||r.y==0)return!0;let o=r.y/r.x,a=s.y-s.x*o,d=t*o+a;return e-h<=d&&d<=e+h}getExtents(){let t,e,s,i;return this.startPoint.x<this.endPoint.x?(t=this.startPoint.x,e=this.endPoint.x):(e=this.startPoint.x,t=this.endPoint.x),this.startPoint.y<this.endPoint.y?(s=this.startPoint.y,i=this.endPoint.y):(i=this.startPoint.y,s=this.endPoint.y),{x:t,y:s,width:e-t,height:i-s}}flip(){let t=this.startPoint;this.startPoint=this.endPoint,this.endPoint=t}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,x2:this.endPoint.x,y2:this.endPoint.y,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness}}static Deserialize=function(t){return new n(t.x,t.y,t.x2,t.y2,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var b=class n extends k{constructor(t,e,s,i,h,r,o,a,d,u,f){a=a??2,u=u??1,super(t,e,s,i,h,o||"#000",a,d||"Solid",u),this.fill=r||"#fff",this.cleanFill=f||!1,this.type="Rectangle"}hitTest(t,e){if(this.fill=="rgba(0,0,0,0)"||this.fill=="transparent")return this.strokeHitTest(t,e);super.hitTest(t,e)}strokeHitTest(t,e){var s=C({x:t,y:e},{x:this.x+this.width/2,y:this.y+this.height/2},-this.angle),i=this.x,h=this.x+this.width,r=this.y,o=this.y+this.height;if(s.x<i||s.x>h||s.y<r||s.y>o)return!1;let a=this.strokeThickness*1.5;return s.x>=i-a&&s.x<=i+a&&s.y>=r&&s.y<=o||s.x>=h-a&&s.x<=h+a&&s.y>=r&&s.y<=o||s.y>=r-a&&s.y<=r+a&&s.x>=i&&s.x<=h||s.y>=o-a&&s.y<=o+a&&s.x>=i&&s.x<=h}draw(t){this._trasformContext(t),t.fillStyle=this.fill,t.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.strokeRect(-this.width/2,-this.height/2,this.width,this.height)),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.strokeColor=this.stroke,t.strokeThickness=this.strokeThickness,t.strokeType=this.strokeType,t.strokeRoughness=this.strokeRoughness,t.cleanFill=this.cleanFill,t}breakApart(){return[new n(this.x,this.y,this.width,this.height,this.angle,this.fill,"rgba(0,0,0,0)",0,this.strokeType,0,this.cleanFill),new g(this.x,this.y,this.x+this.width,this.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new g(this.x+this.width,this.y,this.x+this.width,this.y+this.height,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new g(this.x+this.width,this.y+this.height,this.x,this.y+this.height,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new g(this.x,this.y+this.height,this.x,this.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness)]}static Deserialize(t){return new n(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness,t.cleanFill)}};var B=class n extends k{constructor(t,e,s,i,h,r,o,a,d,u){a=a??2,u=u??1,super(t,e,s,i,h,o||"#000",a,d||"Solid",u),this.fill=r||"#fff",this.type="Ellipse"}draw(t){this._trasformContext(t),t.fillStyle=this.fill;var e=-this.width/2,s=-this.height/2,i=this.width,h=this.height,r=.5522848,o=i/2*r,a=h/2*r,d=e+i,u=s+h,f=e+i/2,c=s+h/2;t.beginPath(),t.moveTo(e,c),t.bezierCurveTo(e,c-a,f-o,s,f,s),t.bezierCurveTo(f+o,s,d,c-a,d,c),t.bezierCurveTo(d,c+a,f+o,u,f,u),t.bezierCurveTo(f-o,u,e,c+a,e,c),t.closePath(),t.fill(),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.stroke()),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.strokeColor=this.stroke,t.strokeThickness=this.strokeThickness,t.strokeType=this.strokeType,t.strokeRoughness=this.strokeRoughness,t}static Deserialize(t){return new n(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var W=class n extends k{constructor(t,e,s,i,h,r,o,a){super(t,e,s,i,h),this.fill=r||"#000000",this.text=o||"Text",this.fontSize=a||12,this.type="Text"}getAdorner(){let t=new D(this);return t.drawBoundingBox=!0,t}draw(t){if(this._trasformContext(t),t.fillStyle=this.fill,t.font=this.fontSize+"px Arial",t.textBaseline="hanging",this.width===0||this.height===0){var e=t.measureText(this.text);this.width=e.width,this.height=this.#t()}t.rect(-this.width/2,-this.height/2,this.width,this.height),t.clip(),this.#e(t,this.text,-this.width/2,-this.height/2+this.#t(),this.width,this.#t()),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.content=this.text,t.fontSize=this.fontSize,t}static Deserialize(t){return new n(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.content,t.fontSize)}#t(){return Math.ceil(this.fontSize*1.15)}#e(t,e,s,i,h,r){let o=e.split(" "),a="";i-=r-1;for(let c=0;c<o.length;c++){var d=a+(a.length>0?" ":"")+o[c],u=t.measureText(d),f=u.width;f>h&&c>0?(t.fillText(a,s,i),a=o[c],i+=r):a=d}t.fillText(a,s,i)}};var Y=class n extends k{#t;#e;constructor(t,e,s,i,h,r){super(t,e,s,i,h),this.#e=!1,this.#t=new Image;let o=this;this.#t.onload=function(){o.#e=!0},this.#t.src=r,this.type="Picture"}draw(t){this._trasformContext(t),this.#e?t.drawImage(this.#t,-this.width/2,-this.height/2,this.width,this.height):(t.fillStyle="#ffffff",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle="#000000",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle="#ff0000",t.beginPath(),t.moveTo(-this.width*.7/2,-this.height*.7/2),t.lineTo(this.width*.7/2,this.height*.7/2),t.moveTo(this.width*.7/2,-this.height*.7/2),t.lineTo(-this.width*.7/2,this.height*.7/2),t.closePath(),t.lineWidth=.5,t.stroke()),t.restore()}getDataObject(){var t=super.getDataObject();return t.imgsrc=this.#t.src,t}static Deserialize(t){return new n(t.x,t.y,t.width,t.height,t.angle,t.imgsrc)}};var J=class extends z{constructor(t,e,s){super(t,e,s),this._actualHandles.push(new v(t.startPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.startControlPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endControlPoint,this.zoomLevel,this.offset)),this.updateHandles()}draw(t){t.strokeStyle="#cc4444",t.lineWidth=1,t.beginPath(),t.moveTo(this._actualHandles[0].center.x,this._actualHandles[0].center.y),t.lineTo(this._actualHandles[2].center.x,this._actualHandles[2].center.y),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this._actualHandles[1].center.x,this._actualHandles[1].center.y),t.lineTo(this._actualHandles[3].center.x,this._actualHandles[3].center.y),t.closePath(),t.stroke(),super.draw(t)}};var P=class n extends T{constructor(t,e,s,i,h,r,o,a,d,u,f,c){u=u??2,c=c??1,super(t,e,d||"#000",u,f||"Solid",c),this.startPoint={x:t,y:e},this.endPoint={x:s,y:i},this.startControlPoint={x:h,y:r},this.endControlPoint={x:o,y:a},this.type="BezierLine"}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e,this.endPoint.x+=e,this.startControlPoint.x+=e,this.endControlPoint.x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e,this.endPoint.y+=e,this.startControlPoint.y+=e,this.endControlPoint.y+=e}getAdorner(){return new J(this)}draw(t){this._setStrokeStyle(t),t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y),t.bezierCurveTo(this.startControlPoint.x,this.startControlPoint.y,this.endControlPoint.x,this.endControlPoint.y,this.endPoint.x,this.endPoint.y),t.stroke()}hitTest(t,e){let s=Math.max(this.startPoint.x,this.endPoint.x,this.startControlPoint.x,this.endControlPoint.x),i=Math.max(this.startPoint.y,this.endPoint.y,this.startControlPoint.y,this.endControlPoint.y),h=document.createElement("canvas");h.width=s,h.height=i;let r=h.getContext("2d");r.lineWidth=10,r.strokeStyle="#ff0000",r.beginPath(),r.moveTo(this.startPoint.x,this.startPoint.y),r.bezierCurveTo(this.startControlPoint.x,this.startControlPoint.y,this.endControlPoint.x,this.endControlPoint.y,this.endPoint.x,this.endPoint.y),r.stroke();var o=r.getImageData(t,e,1,1);return o.data[0]==255&&o.data[1]==0&&o.data[2]==0}getExtents(){let t,e,s,i;return this.startPoint.x<this.endPoint.x?(t=this.startPoint.x,e=this.endPoint.x):(e=this.startPoint.x,t=this.endPoint.x),this.startPoint.y<this.endPoint.y?(s=this.startPoint.y,i=this.endPoint.y):(i=this.startPoint.y,s=this.endPoint.y),{x:t,y:s,width:e-t,height:i-s}}flip(){let t=this.startPoint;this.startPoint=this.endPoint,this.endPoint=t;let e=this.startControlPoint;this.startControlPoint=this.endControlPoint,this.endControlPoint=e}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,x2:this.endPoint.x,y2:this.endPoint.y,cx1:this.startControlPoint.x,cy1:this.startControlPoint.y,cx2:this.endControlPoint.x,cy2:this.endControlPoint.y,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness}}static Deserialize=function(t){return new n(t.x,t.y,t.x2,t.y2,t.cx1,t.cy1,t.cx2,t.cy2,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var K=class extends z{constructor(t,e,s){super(t,e,s);let i=new v(t.startPoint,this.zoomLevel,this.offset);this._actualHandles.push(i);for(var h=0;h<t.remainingPoints.length;h++)h==t.remainingPoints.length-1&&t.remainingPoints[h].x==t.startPoint.x&&t.remainingPoints[h].y==t.startPoint.y?i.linkedPoint=t.remainingPoints[h]:this._actualHandles.push(new v(t.remainingPoints[h],this.zoomLevel,this.offset));this.updateHandles()}draw(t){t.strokeStyle="#cc4444",t.lineWidth=1;for(var e=1;e<this._actualHandles.length;e+=3){t.beginPath(),t.moveTo(this._actualHandles[e-1].center.x,this._actualHandles[e-1].center.y),t.lineTo(this._actualHandles[e].center.x,this._actualHandles[e].center.y),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this._actualHandles[e+1].center.x,this._actualHandles[e+1].center.y);let s=e+2==this._actualHandles.length?0:e+2;t.lineTo(this._actualHandles[s].center.x,this._actualHandles[s].center.y),t.closePath(),t.stroke()}super.draw(t)}};var $=class n extends T{constructor(t,e,s,i,h,r,o,a,d){r=r??2,a=a??1,super(t,e,h||"#000",r,o||"Solid",a),this.startPoint={x:t,y:e},this.remainingPoints=s,this.fill=i||"rgba(0,0,0,0)",this.type="BezierPoly",this.cleanFill=d||!1}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e;for(let s=0;s<this.remainingPoints.length;s++)this.remainingPoints[s].x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e;for(let s=0;s<this.remainingPoints.length;s++)this.remainingPoints[s].y+=e}getAdorner(){return new K(this)}draw(t){t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y);for(var e=0;e<this.remainingPoints.length/3;e++){let s=this.remainingPoints[e*3],i=this.remainingPoints[e*3+1],h=this.remainingPoints[e*3+2];t.bezierCurveTo(s.x,s.y,i.x,i.y,h.x,h.y)}t.closePath(),t.fillStyle=this.fill,t.fill(),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.stroke())}hitTest(t,e){let s=this.remainingPoints.map(function(f){return f.x});s.push(this.startPoint.x);let i=this.remainingPoints.map(function(f){return f.y});i.push(this.startPoint.y);let h=Math.max(...s),r=Math.max(...i),o=document.createElement("canvas");o.width=h,o.height=r;let a=o.getContext("2d");a.lineWidth=10,a.strokeStyle="#ff0000",a.fillStyle="#ff0000",a.beginPath(),a.moveTo(this.startPoint.x,this.startPoint.y);for(var d=0;d<this.remainingPoints.length/3;d++){let f=this.remainingPoints[d*3],c=this.remainingPoints[d*3+1],y=this.remainingPoints[d*3+2];a.bezierCurveTo(f.x,f.y,c.x,c.y,y.x,y.y)}a.fill(),a.stroke();var u=a.getImageData(t,e,1,1);return u.data[0]==255&&u.data[1]==0&&u.data[2]==0}getExtents(){let t=this.remainingPoints.map(function(o){return o.x});t.push(this.startPoint.x);let e=this.remainingPoints.map(function(o){return o.y});e.push(this.startPoint.y);let s=Math.min(...t),i=Math.max(...t),h=Math.min(...e),r=Math.max(...e);return{x:s,y:h,width:i-s,height:r-h}}breakApart(){let t=[new n(this.x,this.y,this.remainingPoints,this.fill,"rgba(0,0,0,0)",null,null,null,this.cleanFill)],e=this.startPoint;for(var s=0;s<this.remainingPoints.length/3;s++){let i=this.remainingPoints[s*3],h=this.remainingPoints[s*3+1],r=this.remainingPoints[s*3+2];t.push(new P(e.x,e.y,r.x,r.y,i.x,i.y,h.x,h.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness)),e=r}return t}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,remainingPoints:this.remainingPoints,fillColor:this.fill,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness,cleanFill:this.cleanFill}}static Deserialize=function(t){return new n(t.x,t.y,t.remainingPoints,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness,t.cleanFill)}};var Q=class extends M{constructor(t,e,s){super(t,e,s)}draw(t){let e=this._shape.x*this.zoomLevel+this.offset.x,s=this._shape.y*this.zoomLevel+this.offset.y,i=this._shape.width*this.zoomLevel,h=this._shape.height*this.zoomLevel;t.strokeStyle="#fff",t.setLineDash([3,3]),t.lineWidth=1,t.strokeRect(e,s,i,h),t.setLineDash([])}getHandleAtCoords(t){return!1}};var _=class n extends k{#t;constructor(t){super(0,0,0,0,0),this.#t=t||[];let e=this.getMaxExtents();this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.type="GroupedShapes"}get shapes(){return this.#t}getAdorner(){return new Q(this)}moveBy(t,e){let s=this.x,i=this.y;super.moveBy(t,e);let h=this.x-s,r=this.y-i;for(let o=0;o<this.#t.length;o++)this.#t[o].x+=h,this.#t[o].y+=r}scaleBy(t){super.scaleBy(t);for(let e=0;e<this.#t.length;e++)this.#t[e].width+=t.y,this.#t[e].height+=t.y}draw(t){for(let e=0;e<this.#t.length;e++)this.#t[e].draw(t)}hitTest(t,e){for(let s=this.#t.length-1;s>=0;s--)if(this.#t[s].hitTest(t,e))return this.#t[s];return!1}getMaxExtents(){if(this.#t.length==0)return{x:0,y:0,width:0,height:0};let t=this.#t[0].getExtents();for(let e=1;e<this.#t.length;e++)t=R(t,this.#t[e].getExtents());return t}breakApart(){return this.#t}getDataObject(){for(var t=[],e=0;e<this.#t.length;e++)t.push(this.#t[e].serialize());return t}static Deserialize(t){let e=[];for(let s=0;s<t.length;s++){let i=t[s].type;if(!i||!t[s].data)continue;let h=JSON.parse(t[s].data),r=Z(i,h);r&&e.push(r)}return new n(e)}};var R=function(n,t){var e={};return e.x=n.x<t.x?n.x:t.x,e.y=n.y<t.y?n.y:t.y,e.width=(n.x+n.width>t.x+t.width?n.x+n.width:t.x+t.width)-e.x,e.height=(n.y+n.height>t.y+t.height?n.y+n.height:t.y+t.height)-e.y,e},C=function(n,t,e){return e=e*Math.PI/180,{x:Math.cos(e)*(n.x-t.x)-Math.sin(e)*(n.y-t.y)+t.x,y:Math.sin(e)*(n.x-t.x)+Math.cos(e)*(n.y-t.y)+t.y}},S=function(n,t){for(var e=0;e<n.length;e++){var s=n[e],i=Math.floor(s/t)*t,h=Math.ceil(s/t)*t;n[e]=s-i<h-s?i:h}return n},Z=function(n,t){let e=null;switch(n){case"Rectangle":e=b.Deserialize(t);break;case"Ellipse":e=B.Deserialize(t);break;case"Line":e=g.Deserialize(t);break;case"Text":e=W.Deserialize(t);break;case"XImage":case"Picture":e=Y.Deserialize(t);break;case"BezierLine":e=P.Deserialize(t);break;case"BezierPoly":e=$.Deserialize(t);break;case"GroupedShapes":e=_.Deserialize(t);break}return e};var V=class{#t;#e;constructor(){this.#t={},this.#e=[]}set zoomLevel(t){Object.keys(this.#t).forEach(function(e){this.#t[e].zoomLevel=t})}set offset(t){Object.keys(this.#t).forEach(function(e){this.#t[e].offset=t})}addAdorner(t,e){this.#e.indexOf(t)>-1||(this.#e.push(t),this.#t[this.#e.length-1]=e)}removeAdorner(t){let e=this.#e.indexOf(t);if(e!=-1){this.#e.splice(e,1),delete this.#t[e];var s={},i=0;for(var h in this.#t)s[i]=this.#t[h],i++;this.#t=s}}getAdonerForShape(t){let e=this.#e.indexOf(t);return this.#t[e]}getAdornerHandleAtCoords(t){for(var e in this.#t){var s=this.#t[e].getHandleAtCoords(t);if(s)return s}return null}updateHandles(){for(var t in this.#t)this.#t[t].updateHandles()}clear(){this.#t={},this.#e=[]}draw(t){for(var e in this.#t)this.#t[e].draw(t)}};var tt=class{#t;#e;#n;#s;#h;#o;#a;#l;#d;#i;#r;constructor(t){this.#t=t,this.width=this.#t.width,this.height=this.#t.height,this.#e=new N(this.#t),this.#n=this.#e.context,this.shapeLayers=[],this.snapToGrid=!1,this.grid=null,this.extent=null,this.#i=[],this.#d=[],this.#a=[],this.#r=[],this.adorners=new V,this.zoomLevel=1,this.offset={x:0,y:0},this.gridColour="rgba(0,100,255,0.1)",this.backgroundColour=null,this.#l=new w(this);let e=this;t.addEventListener("mousedown",s=>{s.preventDefault();let i=e.#c(s);e.activeTool?.mouseDown(i)}),t.addEventListener("mousemove",s=>{let i=e.#c(s);e.activeTool?.mouseMove(i)}),t.addEventListener("mouseup",s=>{let i=e.#c(s);e.activeTool?.mouseUp(i)}),window.requestAnimationFrame(function(s){return function(){s.#u()}}(this))}get offset(){return this.#s}set offset(t){this.#s=t,this.adorners.offset=t}get zoomLevel(){return this.#h}set zoomLevel(t){this.#h=t,this.adorners.zoomLevel=t}get activeTool(){return this.#l}set activeTool(t){this.#l=t,this.#d.forEach(e=>e(t)),this.deselectAllShapes()}get activeLayer(){return this.#o}set activeLayer(t){let e=this;this.#o=t,this.#o.contentsChangedCallback=()=>{e.updated()}}get selectedShapes(){return this.#i}updated(){this.#a.forEach(t=>t())}selectShape(t){if(!t||this.#i.indexOf(t)>-1)return;this.#i.push(t);let e=t.getAdorner();e.zoomLevel=this.zoomLevel,e.offset=this.offset,this.adorners.addAdorner(t,e),this.#r.forEach(s=>s(t))}startDragSelectedShapes(){for(let t=0;t<this.#i.length;t++)this.#i[t].startDrag()}selectShapesInRect(t){let e=this.activeLayer.getShapesInRect(t);for(let s=0;s<e.length;s++)this.selectShape(e[s])}deselectShape(t){let e=this.#i.indexOf(t);e!=-1&&(this.#i.splice(e,1),this.adorners.removeAdorner(t),this.#r.forEach(s=>s(null)))}deselectAllShapes(){for(let t=0;t<this.#i.length;t++)this.#i[t].selected=!1;this.#i=[],this.adorners.clear(),this.#r.forEach(t=>t(null))}shapeIsSelected(t){return this.#i.indexOf(t)>-1}moveSelectedShapesBy(t,e){for(let s=0;s<this.#i.length;s++)this.#i[s].moveBy(t,e);this.adorners.updateHandles(),this.updated()}deleteSelectedShapes(){for(let t=0;t<this.#i.length;t++)this.activeLayer.removeShape(this.#i[t]);this.deselectAllShapes(),this.updated()}breakApartSelectedShapes(){for(let t=0;t<this.#i.length;t++){let e=this.#i[t],s=e.breakApart();for(let i=0;i<s.length;i++)this.activeLayer.add(s[i]);s.length>0&&this.activeLayer.removeShape(e)}this.deselectAllShapes(),this.updated()}groupSelectedShapes(){let t=new _(this.#i);this.deleteSelectedShapes(),this.activeLayer.add(t),this.selectShape(t),this.updated()}duplicateSelectedShapes(){let t=new _(this.#i),e=_.Deserialize(JSON.parse(t.serialize().data));this.deselectAllShapes();for(let s=0;s<e.shapes.length;s++)this.activeLayer.add(e.shapes[s]),this.selectShape(e.shapes[s]);this.moveSelectedShapesBy({x:10,y:10},this.snapToGrid?this.grid:null),this.updated()}moveSelectedShapesUp(){for(let t=0;t<this.#i.length;t++)this.activeLayer.moveShapeUp(this.#i[t]);this.updated()}moveSelectedShapesDown(){for(let t=0;t<this.#i.length;t++)this.activeLayer.moveShapeDown(this.#i[t]);this.updated()}nudgeSelectedShapes(t){if(this.#i.length==0)return;let e={x:t.x,y:t.y};if(this.snapToGrid&&this.grid){let s=this.#i[0],i=S([s.x,s.y],this.grid),h=t.x!=0?i[0]-s.x:0,r=t.y!=0?i[1]-s.y:0;e.x=(t.x/Math.abs(t.x)||0)*this.grid+h,e.y=(t.y/Math.abs(t.y)||0)*this.grid+r}for(let s=0;s<this.#i.length;s++)this.#i[s].moveBy(e);this.adorners.updateHandles(),this.updated()}getMaxExtents(){if(this.shapeLayers.length==0)return{x:0,y:0,width:0,height:0};let t=this.shapeLayers[0].getMaxExtents();for(let e=1;e<this.shapeLayers.length;e++)t=R(t,this.shapeLayers[e].getMaxExtents());return t}centreContent(){let t=this.getMaxExtents(),e={x:(this.#t.width()-t.width*this.#h)/2,y:(this.#t.height()-t.height*this.#h)/2};this.offset=e}zoomToExtents(){let t=this.getMaxExtents(),e=this.#t.width()/t.width,s=this.#t.height()/t.height,i=e>s?s:e;this.zoomLevel=i,this.centreContent()}addActiveToolChangedListener(t){this.#d.push(t)}addActiveLayerUpdatedListener(t){this.#a.push(t)}addSelectedShapesChangedListener(t){this.#r.push(t)}#u(){this.#n.clearRect(0,0,this.width,this.height),this.backgroundColour&&(this.#n.fillStyle=this.backgroundColour,this.#n.fillRect(0,0,this.width,this.height)),this.#n.save(),this.#n.translate(this.#s.x,this.#s.y),this.#n.scale(this.#h,this.#h),this.#f(),this.#p();for(var t=0;t<this.shapeLayers.length;t++)this.shapeLayers[t].draw(this.#n);this.#n.restore(),this.adorners.draw(this.#n),this.selectionRect&&(this.#n.save(),this.#n.strokeStyle="#fff",this.#n.setLineDash([5,5]),this.#n.lineWidth=1,this.#n.strokeRect(this.selectionRect.x,this.selectionRect.y,this.selectionRect.width,this.selectionRect.height),this.#n.restore()),window.requestAnimationFrame(function(e){return function(){e.#u()}}(this))}#f(){if(this.grid){var t=this.#n;t.strokeStyle=this.gridColour,t.lineWidth=1,t.setLineDash([]);for(var e=0;e<=this.width;e+=this.grid)t.beginPath(),t.moveTo(e,0),t.lineTo(e,this.height),t.closePath(),t.stroke();for(var s=0;s<=this.height;s+=this.grid)t.beginPath(),t.moveTo(0,s),t.lineTo(this.width,s),t.closePath(),t.stroke()}}#p(){var t=this.#n;if(this.origin&&(t.strokeStyle="rgba(255,0,0,0.2)",t.lineWidth=1,t.beginPath(),t.moveTo(this.origin.x,0),t.lineTo(this.origin.x,this.height),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(0,this.origin.y),t.lineTo(this.width,this.origin.y),t.closePath(),t.stroke()),this.extent){let e=this.origin.x>this.width/4?-this.extent:this.extent;t.strokeStyle="rgba(0,200,0,0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(this.origin.x+e,0),t.lineTo(this.origin.x+e,this.height),t.closePath(),t.stroke()}}#c(t){var e={x:t.pageX-this.#t.offsetLeft,y:t.pageY-this.#t.offsetTop,shiftKey:t.shiftKey};return this.#y(e)}#y(t){return t.xTrans=(t.x-this.#s.x)/this.#h,t.yTrans=(t.y-this.#s.y)/this.#h,t}};var G=class n{contentsChangedCallback=null;#t;constructor(t){this.#t=t||[],this.opacity=1}get length(){return this.#t.length}get shapes(){return this.#t}add(t){this.#t.push(t),this.contentsChangedCallback&&this.contentsChangedCallback(this)}draw(t){t.globalAlpha=this.opacity;for(let e=0;e<this.#t.length;e++)this.#t[e].draw(t);t.globalAlpha=1}hitTest(t,e){for(let s=this.#t.length-1;s>=0;s--)if(this.#t[s].hitTest(t,e))return this.#t[s];return!1}getShapeIndex(t){let e=-1;for(let s=this.#t.length-1;s>=0;s--)if(this.#t[s]===t){e=s;break}return e}containsShape(t){return this.getShapeIndex(t)>-1}removeShape(t){let e=this.getShapeIndex(t);this.#t.splice(e,1),this.contentsChangedCallback&&this.contentsChangedCallback(this)}moveShapeUp(t){let e=this.getShapeIndex(t);e!==this.#t.length-1&&(this.#t.splice(e,1),this.#t.push(t),this.contentsChangedCallback&&this.contentsChangedCallback(this))}moveShapeDown(t){let e=this.getShapeIndex(t);e!==0&&(this.#t.splice(e,1),this.#t.splice(e-1,0,t),this.contentsChangedCallback&&this.contentsChangedCallback(this))}getShapesInRect(t){let e=[];for(let s=0;s<this.#t.length;s++){let i=this.#t[s].getExtents();i.x<t.x+t.width&&i.x+i.width>t.x&&i.y<t.y+t.height&&i.y+i.height>t.y&&e.push(this.#t[s])}return e}getMaxExtents(){if(this.#t.length==0)return{x:0,y:0,width:0,height:0};let t=this.#t[0].getExtents();for(let e=1;e<this.#t.length;e++)t=R(t,this.#t[e].getExtents());return t}serialize(){let t=[];for(let e=0;e<this.#t.length;e++)t.push(this.#t[e].serialize());return t}static Deserialize(t){let e=new n;for(let s=0;s<t.length;s++){let i=t[s].type;if(!i||!t[s].data)continue;let h=JSON.parse(t[s].data),r=Z(i,h);r&&e.add(r)}return e}};var A=class extends L{constructor(t){super(t),this._grid=t.snapToGrid?t.grid:null}mouseDown(t){super.mouseDown(t),this._snapToGrid(t)}_snapToGrid(t){if(this._grid){var e=S([t.xTrans,t.yTrans],this._grid);t.xTrans=e[0],t.yTrans=e[1]}}};var I=class extends A{constructor(t,e,s){super(t),this._lineToAdd=new g(0,0,0,0,e.strokeColor,e.strokeThickness,e.strokeType),this._line=null,this._keepDrawing=s&&s.keepDrawing||!1}mouseMove(t){if(this._mouseButtonDown){var e={x:t.x-this._lastMouseCoords.x,y:t.y-this._lastMouseCoords.y};this._snapToGrid(t),!this._line&&(Math.abs(e.x)>20||Math.abs(e.y)>20)&&(this._line=this._lineToAdd,this._dc.activeLayer.add(this._line),this._line.startPoint.x=this._lastMouseCoords.xTrans,this._line.startPoint.y=this._lastMouseCoords.yTrans),this._line&&(this._line.endPoint.x=t.xTrans,this._line.endPoint.y=t.yTrans)}}mouseUp(t){super.mouseUp(t),this._line&&(this._dc.updated(),this._keepDrawing?(this._lineToAdd=new g(0,0,0,0,this._line.stroke,this._line.strokeThickness,this._line.strokeType),this._line=null):(this._dc.activeTool=new w(this._dc),this._dc.selectShape(this._line)))}};var et=class extends I{constructor(t,e){super(t,e),this._lineToAdd=new P(0,0,0,0,0,0,0,0,e.strokeColor,e.strokeThickness,e.strokeType)}mouseMove(t){if(super.mouseMove(t),this._mouseButtonDown&&this._line){let e={x:this._line.startPoint.x+(this._line.endPoint.x-this._line.startPoint.x)/3,y:this._line.startPoint.y+(this._line.endPoint.y-this._line.startPoint.y)/3},s={x:this._line.startPoint.x+(this._line.endPoint.x-this._line.startPoint.x)*2/3,y:this._line.startPoint.y+(this._line.endPoint.y-this._line.startPoint.y)*2/3};this._line.startControlPoint=e,this._line.endControlPoint=s}}};var F=class n extends A{#t;#e;constructor(t,e){if(super(t),this.constructor==n)throw new Error("Abstract classes can't be instantiated.");this.#t=e,this.#e=null}mouseMove(t){if(this._mouseButtonDown){var e={x:t.x-this._lastMouseCoords.x,y:t.y-this._lastMouseCoords.y};if(!this.#e&&(Math.abs(e.x)>=20||Math.abs(e.y)>=20)&&(this.#e=this.#t,this._dc.activeLayer.shapes.push(this.#e)),this.#e){this._snapToGrid(t);var s={x:Math.abs(t.xTrans-this._lastMouseCoords.xTrans),y:Math.abs(t.yTrans-this._lastMouseCoords.yTrans)},i={x:e.x<0?-1:0,y:e.y<0?-1:0};this.#e.x=this._lastMouseCoords.xTrans+s.x*i.x,this.#e.y=this._lastMouseCoords.yTrans+s.y*i.y,this.#e.width=s.x,this.#e.height=s.y}}}mouseUp(t){var e={x:t.x-this._lastMouseCoords.x,y:t.y-this._lastMouseCoords.y};!this.#e&&(Math.abs(e.x)<2||Math.abs(e.y)<2)&&(this.#e=this.#t,this.#e.x=this._lastMouseCoords.xTrans,this.#e.y=this._lastMouseCoords.yTrans,this.#e.width=20,this.#e.height=20,this._dc.activeLayer.shapes.push(this.#e)),super.mouseUp(t),this.#e&&(this.#e.selected=!0,this._dc.activeTool=new w(this._dc),this._dc.selectShape(this.#e))}};var st=class extends F{constructor(t,e){super(t,new b(0,0,0,0,0,e.fillColor,e.strokeColor,e.strokeThickness,e.strokeType))}};var it=class extends F{constructor(t,e){super(t,new B(0,0,0,0,0,e.fillColor,e.strokeColor,e.strokeThickness,e.strokeType))}};var U={_fonts:null,loadFonts:function(){if(this._fonts===null){let n=localStorage.getItem("fonts");n?n=JSON.parse(n):n=[],this._fonts=n}return this._fonts},loadFontByName:function(n){let t=this.loadFonts();for(let e=0;e<t.length;e++){let s=t[e];if(s.name==n)return s}return null},saveFonts:function(n){this._fonts=n,localStorage.setItem("fonts",JSON.stringify(n))},importFontFromCode:function(n,t){let e=/\s{'(.)',\s\(const\suint8_t\[\]\)\s?{[^}]*},[^}]*},/gm,s=[...t.matchAll(e)],i={name:n,letters:[]};if(s)for(let h=0;h<s.length;h++){let r=s[h],o=r[1],a=r[0];i.letters.push({letter:o,code:a})}else return!1;return this._fonts.push(i),this.saveFonts(this._fonts),!0},exportFontCode:function(n){let t="";for(let e=0;e<n.letters.length;e++){let s=n.letters[e];t+=s.code+`
`}return t=t.replace(/,\s*$/,""),t},serializeLetter:function(n,t,e,s,i){let h=this._serializeLines(t,s,i),r=(h.length+2)/6;return"  {'"+n+"', (const uint8_t[]){ "+h+" }, "+r+", "+e+"},"},deserializeLetter:function(n,t,e,s,i){let h=/\s?{'(.)', \(const uint8_t\[\]\){ ((?:0x[A-Fa-f0-9]{2},? )+)}, (\d+), (\d+)}/gm,r=h.exec(n),o={letter:"",hexString:"",letterWidth:0,shapes:[],og:!1};if(r==null){h=/{((?:\s*\d+,?)+)\s*}/gm;let a=h.exec(n);if(a==null)return null;o.hexString=a[1],o.shapes=this._deserializeOgLines(o.hexString,t,e,s,i),o.og=!0}else o.letter=r[1],o.hexString=r[2],o.letterWidth=r[4],o.shapes=this._deserializeLines(o.hexString,t,e,s,i);return o},_serializeLines:function(n,t,e){let s=[];if(n.length==0)return"0x00";n=n.map(l=>l instanceof g?{startPoint:l.startPoint,endPoint:l.endPoint}:l instanceof P?{startPoint:l.startPoint,endPoint:l.endPoint,startControlPoint:l.startControlPoint,endControlPoint:l.endControlPoint}:null).filter(l=>l!==null);var i=function(l){let p=[];for(let x=0;x<n.length;x++){let m=n[x];s.includes(m)==!1&&m.startPoint.x==l.x&&m.startPoint.y==l.y&&p.push(m),s.includes(m)==!1&&m.endPoint.x==l.x&&m.endPoint.y==l.y&&p.push(m)}return p};let h=[];for(let l=0;l<n.length;l++){let p=n[l],x=i(p.startPoint),m=i(p.endPoint);h.push({index:l,line:p,startShapes:x.length,endShapes:m.length})}h=h.filter(l=>l.startShapes==1||l.endShapes==1);let r=Number.MAX_VALUE,o=null;for(let l=0;l<h.length;l++){let p=h[l],x=Math.sqrt(Math.pow(p.line.startPoint.x,2)+Math.pow(p.line.startPoint.y,2));x<r&&(r=x,o=p)}let a=function(l){let p=l.startPoint;l.startPoint=l.endPoint,l.endPoint=p,l.startControlPoint&&(p=l.startControlPoint,l.startControlPoint=l.endControlPoint,l.endControlPoint=p)},d=function(l){let p=l,x=null;do{x=i(p);for(let m=0;m<x.length;m++){let E=x[m];if(s.includes(E)==!1){(E.startPoint.x!=p.x||E.startPoint.y!=p.y)&&a(E),s.push(E),p=E.endPoint;break}}}while(x.length>0)};if(s=[],o!=null)s.push(o.line),o.startShapes>1&&a(o.line),d(o.line.endPoint);else{let l=n[0];s.push(l),d(l.endPoint)}for(let l=0;l<n.length;l++){let p=n[l];s.includes(p)==!1&&(s.push(p),d(p.endPoint))}let u=new ht,f=function(l){u.append(parseInt(l.x/t),4),u.append(parseInt(e-1-l.y/t),4)},c={x:0,y:0};for(let l=0;l<s.length;l++){let p=s[l];(p.startPoint.x!=c.x||p.startPoint.y!=c.y)&&(u.append(0,1),u.append(0,1),f(p.startPoint)),p.startControlPoint||(u.append(1,1),u.append(0,1),f(p.endPoint)),p.startControlPoint&&(u.append(1,1),u.append(1,1),f(p.endPoint),f(p.startControlPoint),f(p.endControlPoint)),c=p.endPoint}let y=u.serializeToHex();return y=y.substring(0,y.length-2),y},_deserializeLines:function(n,t,e,s,i){let h=[],r={x:0,y:0},o=new rt(n),a=function(){return{x:o.read(4)*t,y:(e-1-o.read(4))*t}};for(;o.eof==!1;){let d=o.read(1),u=o.read(1),f=a();if(d==1)if(u==0){let c=new g(r.x,r.y,f.x,f.y,s,i);h.push(c)}else{let c=a(),y=a(),l=new P(r.x,r.y,f.x,f.y,c.x,c.y,y.x,y.y,s,i);h.push(l)}r=f}return h},_deserializeOgLines:function(n,t,e,s,i){let h=n.split(",").map(a=>parseInt(a.trim())),r=[],o={x:0,y:0};for(let a=0;a<h.length;a++){let d=h[a];if(d==200)break;let u=0;d>99&&(u=1,d-=100);let f=parseInt(d/10),c=d-f*10;f*=3,c*=3;let y={x:f*t,y:(e-1-c)*t};if(u==1){let l=new g(o.x,o.y,y.x,y.y,s,i);r.push(l)}o=y}return r}},ht=class{constructor(){this.bytes=[0],this.nextBit=0,this.currentByteIndex=0,this.totalBits=0}append(t,e){let s=this.bytes[this.currentByteIndex],i=8-this.nextBit-e,h=i<0?t>>>i*-1:t<<i,r=s|h;if(this.bytes[this.currentByteIndex]=r,this.nextBit=(this.nextBit+e)%8,this.totalBits+=e,this.nextBit==0&&(this.currentByteIndex++,this.bytes.push(0)),i<0){this.currentByteIndex++,i=8+i;let o=(0|t<<i)&255;this.bytes.push(o)}}serializeToHex(){let t="";for(let e=0;e<this.bytes.length;e++){let s=this.bytes[e];t+="0x"+(s>>>0).toString(16).padStart(2,"0")+", "}return t}outputBits(){let t="";for(let e=0;e<this.bytes.length;e++){let s=this.bytes[e];console.log(e+": "+(s>>>0).toString(2).padStart(8,"0")+" ")}}},rt=class{constructor(t){this.data=[],this.currentByteIndex=0,this.nextBit=0,this.totalBits=0;let e=t.split(",").map(s=>s.trim());for(let s=0;s<e.length;s++){let i=parseInt(e[s],16);isNaN(i)||this.data.push(i)}}get eof(){return this.currentByteIndex>=this.data.length}read(t){let e=this.data[this.currentByteIndex],s=this.nextBit,i=8-t,h=(e<<s&255)>>>i;return this.nextBit+t>8&&(this.currentByteIndex++,e=this.data[this.currentByteIndex],i=8-(s-i),h=h|e>>>i),this.nextBit=(this.nextBit+t)%8,this.nextBit==0&&this.currentByteIndex++,this.totalBits+=t,h}};var H={_modalsInititalized:!1,_currentModalNoClose:!1,showModal:function(n,t){let e=document.getElementById(n),s=document.getElementById("modalOverlay");if(s.appendChild(e),s.style.display="flex",this._currentModalNoClose=t,this._modalsInititalized)return;this._modalsInititalized=!0;let i=document.querySelectorAll(".modal .close-button");s.addEventListener("click",h=>{h.target===s&&!this._currentModalNoClose&&H.hideModal()}),i.forEach(h=>{h.addEventListener("click",()=>{H.hideModal()})})},hideModal:function(n){let t=document.getElementById("modalOverlay"),e=document.querySelectorAll("#modalOverlay .modal")[0],s=document.getElementById("modals");t.style.display="none",t.removeChild(e),s.appendChild(e)},makeEditable:function(n,t){let e=this;n.addEventListener("click",s=>{s.target==n&&e._editText(n,i=>{let h=n.innerText;n.innerText=i,t(i,h)})})},_editText:function(n,t){let e=document.createElement("input");e.style.width="80px",e.value=n.innerText,n.innerText="",n.appendChild(e),e.focus(),e.addEventListener("blur",()=>{n.innerText=e.value,t(e.value)}),e.addEventListener("keydown",s=>{s.key=="Enter"&&(n.innerText=e.value,t(e.value))})}};var nt=class extends L{#t;constructor(t,e){super(t),this.#t=e}mouseUp(t){super.mouseUp(t),this.#t&&this.#t(t)}};var ot={canvas:null,dc:null,fillColor:"rgba(0,0,0,0)",strokeColor:"#9999AA",strokeThickness:5,activeLayer:null,backgroundLayer:null,host:"",init:function(){this.canvas=document.getElementById("drawing"),this.dc=new tt(this.canvas),this.dc.backgroundColour="#664499",this.dc.gridColour="rgba(255,255,255,0.1)",this.dc.activeTool=new w(this.dc),this.setupLayers(),this.setupEventHandlers(),this.populateFontList()},setupLayers:function(){this.dc.deselectAllShapes(),this.backgroundLayer=new G,this.activeLayer=new G,this.dc.shapeLayers=[this.activeLayer,this.backgroundLayer],this.dc.activeLayer=this.activeLayer},setupEventHandlers:function(){let n=this,t=function(l){let p=document.querySelectorAll(".tool");for(let x=0;x<p.length;x++)p[x].classList.remove("active");l.classList.add("active")},e=document.getElementById("btn-select");e.addEventListener("click",function(){n.dc.activeTool=new w(n.dc),t(e)});let s=document.getElementById("btn-line");s.addEventListener("click",function(){n.dc.activeTool=new I(n.dc,{strokeColor:n.strokeColor,strokeThickness:n.strokeThickness}),t(s)});let i=document.getElementById("btn-bez");i.addEventListener("click",function(){n.dc.activeTool=new et(n.dc,{strokeColor:n.strokeColor,strokeThickness:n.strokeThickness}),t(i)});let h=document.getElementById("btn-rect");h.addEventListener("click",function(){n.dc.activeTool=new st(n.dc,{fillColor:n.fillColor,strokeColor:n.strokeColor,strokeThickness:n.strokeThickness}),t(h)});let r=document.getElementById("btn-ellipse");r.addEventListener("click",function(){n.dc.activeTool=new it(n.dc,{fillColor:n.fillColor,strokeColor:n.strokeColor,strokeThickness:n.strokeThickness}),t(r)});let o=null,a=document.getElementById("btn-text");a.addEventListener("click",function(){t(a),n.dc.activeTool=new nt(n.dc,function(l){o=l,document.getElementById("text").value="",H.showModal("add-text-modal"),n.dc.activeTool=new w(n.dc),n.dc.deselectAllShapes(),t(e)})}),document.getElementById("btn-add-text").addEventListener("click",function(){let l=document.getElementById("font").value,p=document.getElementById("font-size").value,x=document.getElementById("text").value;n.renderText(l,p,x,o),H.hideModal("add-text-modal")}),document.getElementById("btn-delete").addEventListener("click",function(){n.dc.deleteSelectedShapes()}),document.getElementById("btn-print").addEventListener("click",function(){n.printLabel()}),document.getElementById("btn-pen").addEventListener("click",function(){n.postData("/print","D,0,0"),H.showModal("insert-pen-modal",!0)}),document.getElementById("btn-lift-pen").addEventListener("click",function(){H.hideModal(),n.postData("/print","U,0,0")}),this.dc.addActiveToolChangedListener(function(l){l instanceof w&&t(e)})},renderText:function(n,t,e,s){let i=U.loadFontByName(n);if(!i){console.error("Font not found: "+n);return}let h=t/2.4,r=s.x,o=s.y,a=[];for(let u=0;u<e.length;u++){let f=null;for(let c=0;c<i.letters.length;c++)if(i.letters[c].letter==e[u]){f=i.letters[c];break}if(!f){for(let c=0;c<i.letters.length;c++)if(i.letters[c].letter==e[u].toUpperCase()){f=i.letters[c];break}}if(f){f=U.deserializeLetter(f.code,h,13,this.strokeColor,this.strokeThickness);let c=f.shapes;this.translateShapes(c,r,o);for(let y=0;y<c.length;y++)a.push(c[y]);r+=f.letterWidth*h+h*2}else if(e[u]==" ")r+=h*6;else{let c=9*h,y=12*h;a.push(new b(r,o,c,y,0,this.fillColor,this.strokeColor,this.strokeThickness)),a.push(new g(r,o,r+c,o+y,this.strokeColor,this.strokeThickness)),r+=12*h}}let d=new _(a);this.activeLayer.add(d)},populateFontList:function(){let n=U.loadFonts();n.length==0&&(n=this.downloadFactoryFonts());let t=document.getElementById("font");for(let e=0;e<n.length;e++){let s=n[e],i=document.createElement("option");i.value=s.name,i.textContent=s.name,t.appendChild(i)}},downloadFactoryFonts:function(){let n=["/curves.json","/original.json"],t=[];for(let e=0;e<n.length;e++){let s=n[e],i=new XMLHttpRequest;if(i.open("GET",s,!1),i.overrideMimeType("application/json"),i.send(null),i.status===200){let h=JSON.parse(i.responseText);t.push(h)}else console.error("Error loading font: "+s)}return U.saveFonts(t),t},translateShapes:function(n,t,e){for(let s=0;s<n.length;s++){let i=n[s];i instanceof g?(i.startPoint.x+=t,i.startPoint.y+=e,i.endPoint.x+=t,i.endPoint.y+=e):i instanceof P&&(i.startPoint.x+=t,i.startPoint.y+=e,i.endPoint.x+=t,i.endPoint.y+=e,i.startControlPoint.x+=t,i.startControlPoint.y+=e,i.endControlPoint.x+=t,i.endControlPoint.y+=e)}},printLabel:function(){this.dc.deselectAllShapes(),this.dc.activeTool=null;let n=document.querySelectorAll("button");for(let r=0;r<n.length;r++)n[r].disabled=!0,n[r].classList.remove("active");let t=[];for(let r=0;r<this.activeLayer.shapes.length;r++){let o=this.activeLayer.shapes[r];if(o instanceof _){let a=o.breakApart();for(let d=0;d<a.length;d++)t.push(a[d])}else t.push(o)}let e=null,s=this,i=function(){if(t.length>0){e=t.shift(),e.stroke="#cc9933";let r=s.serializeShape(e);s.postData("/print",r,h)}else{for(let a=0;a<n.length;a++){n[a].disabled=!1;for(let d=0;d<s.activeLayer.shapes.length;d++)if(s.activeLayer.shapes[d]instanceof _)for(let u=0;u<s.activeLayer.shapes[d].shapes.length;u++)s.activeLayer.shapes[d].shapes[u].stroke=s.strokeColor;else s.activeLayer.shapes[d].stroke=s.strokeColor}let r=s.activeLayer.getMaxExtents(),o=Math.round((r.x+r.width)*10.6);s.postData("/print","X,"+o+",0")}},h=function(){setTimeout(function(){s.get("/status",function(o){o==null&&h(),o.trim()=="waiting"?(e.stroke="#33cc33",i()):h()})},1e3)};i()},serializeShape:function(n){let e=function(h,r){return Math.round(h*10.6)+","+Math.round((300-r)*10.6)},s=function(h,r){return Math.round(h*10.6)+","+Math.round(r*10.6)},i=function(h){return e(h.x,h.y)};return n instanceof g?"L,"+i(n.startPoint)+","+i(n.endPoint):n instanceof P?"B,"+i(n.startPoint)+","+i(n.endPoint)+","+i(n.startControlPoint)+","+i(n.endControlPoint):n instanceof b?"R,"+e(n.x,n.y)+","+s(n.width,n.height):n instanceof B?"E,"+e(n.x,n.y)+","+s(n.width,n.height):""},postData:function(n,t,e){let s=new XMLHttpRequest;s.open("POST",this.host+n,!0),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){s.readyState==4&&s.status==200?e&&e(s.responseText):s.readyState==4&&console.error("Error sending data")},s.send(t)},get:function(n,t){let e=new XMLHttpRequest;e.open("GET",this.host+n,!0),e.onreadystatechange=function(){e.readyState==4&&e.status==200?t&&t(e.responseText):e.readyState==4&&(console.error("Error receiving data"),t&&t(null))},e.send()}};ot.init();})();

)htmljs"