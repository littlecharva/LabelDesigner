R"htmljs(
(()=>{var R=class{constructor(t){this.canvas=t;var e=this.context=t.getContext("2d");this.width=t.width,this.height=t.height;let i=window.devicePixelRatio||1,n=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,r=i/n;if(i!==n){let h=this.width,o=this.height;this.width=t.width=h*r,this.height=t.height=o*r,t.style.width=h+"px",t.style.height=o+"px",e.scale(r,r)}}};var B=class{constructor(t){this._dc=t,this._mouseButtonDown=!1,this._lastMouseCoords=null}mouseDown(t){this._mouseButtonDown=!0,this._lastMouseCoords=t}mouseMove(t){}mouseUp(t){this._mouseButtonDown=!1,this._lastMouseCoords=null}};var S=class extends B{#t;#e;#n;#i;constructor(t){super(t),this.#t=null}mouseDown(t){if(super.mouseDown(t),this.#t=this._dc.adorners.getAdornerHandleAtCoords(t),this.#t){this.#t.startDrag();return}var e=this._dc.activeLayer?.hitTest(t.xTrans,t.yTrans);if(this._dc.shapeIsSelected(e)){t.shiftKey==!0&&(this.#e=e,this.#n=t),this._dc.startDragSelectedShapes();return}e?(t.shiftKey==!1&&this._dc.deselectAllShapes(),e.selected=!0,this._dc.selectShape(e)):t.shiftKey==!1&&(this._dc.deselectAllShapes(),this.#i={x:t.xTrans,y:t.yTrans,width:0,height:0},this._dc.selectionRect={x:t.x,y:t.y,width:0,height:0})}mouseMove(t){if(this._mouseButtonDown&&this.#i){this.#i.width=t.xTrans-this.#i.x,this.#i.height=t.yTrans-this.#i.y,this._dc.selectionRect.width=t.x-this._dc.selectionRect.x,this._dc.selectionRect.height=t.y-this._dc.selectionRect.y;return}if(this._mouseButtonDown&&this._dc.selectedShapes.length){var e={x:t.xTrans-this._lastMouseCoords.xTrans,y:t.yTrans-this._lastMouseCoords.yTrans};this.#t?(this.#t.drag(e,t,this._dc.snapToGrid?this._dc.grid:null),this._dc.adorners.updateHandles(),this._dc.updated()):this._dc.moveSelectedShapesBy(e,this._dc.snapToGrid?this._dc.grid:null),this._lastMouseCoords=t}}mouseUp(t){if(super.mouseUp(t),this.#t=null,this.#e){Math.abs(this.#n.xTrans-t.xTrans)<3&&Math.abs(this.#n.yTrans-t.yTrans)<3&&this._dc.deselectShape(this.#e),this.#e=null;return}if(this.#i){let e={x:this.#i.x,y:this.#i.y,width:Math.abs(this.#i.width),height:Math.abs(this.#i.height)};this.#i.width<0&&(e.x=this.#i.x+this.#i.width),this.#i.height<0&&(e.y=this.#i.y+this.#i.height),this.#i.width>2&&this.#i.height>2&&this._dc.selectShapesInRect(e),this.#i=null,this._dc.selectionRect=null}}};var k=class{#t;#e;#n;#i;#r;constructor(t,e,i,n,r,h){this.x=t,this.y=e,this.#e=i,this.#n=n,this.#i=r,this.#r=h,this.selected=!1}get stroke(){return this.#e}set stroke(t){this.#e&&(this.#e=t)}get strokeThickness(){return this.#n}set strokeThickness(t){this.#n&&(this.#n=t)}get strokeType(){return this.#i}set strokeType(t){this.#i&&(this.#i=t)}get strokeRoughness(){return this.#r}set strokeRoughness(t){this.#r&&(this.#r=t)}draw(t){}startDrag(){this.#t={x:this.x,y:this.y}}moveBy(t,e){if(this.#t||(this.#t={x:this.x,y:this.y}),this.#t.x+=t.x,this.#t.y+=t.y,e){var i=T([this.#t.x,this.#t.y],e);this.x=i[0],this.y=i[1]}else this.x+=t.x,this.y+=t.y}breakApart(){return[]}_setStrokeStyle(t){this.stroke&&(t.strokeStyle=this.stroke);let e=this.strokeThickness;e&&(t.lineWidth=e,this.strokeType&&t.setLineDash(this.strokeType==="Dashed"?[e*3,e*3]:this.strokeType==="Dotted"?[e,e]:[]))}serialize(){return{type:this.type,data:JSON.stringify(this.getDataObject())}}};var C=class{constructor(t,e,i){this._shape=t,this._zoomLevel=e||1,this._offset=i||{x:0,y:0},this._actualHandles=[]}get zoomLevel(){return this._zoomLevel}set zoomLevel(t){this._zoomLevel=t,this.updateHandles()}get offset(){return this._offset}set offset(t){this._offset=t,this.updateHandles()}draw(t){t.fillStyle="#cccccc",t.strokeStyle="#444444";for(var e=0;e<this._actualHandles.length;e++)this._actualHandles[e].draw(t)}updateHandles(){for(var t=0;t<this._actualHandles.length;t++)this._actualHandles[t].updatePosition(this.zoomLevel,this.offset)}};var A=class{constructor(t,e){this._shape=t,this._movement=e,this._origin={x:0,y:0}}hitTest(t){var e=this._actualHandleRect;return t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<=e.y+e.height}_drawSquareHandle(t,e){t.fillRect(e.x,e.y,e.width,e.height),t.strokeRect(e.x,e.y,e.width,e.height)}_getHandleRect(t){return{x:t.x-5,y:t.y-5,width:5*2,height:5*2,cX:t.x,cY:t.y}}},O=class extends A{#t;#e;constructor(t,e,i){super(t,e,i),this.updatePosition(i)}startDrag(){this.#t={x:this._shape.x,y:this._shape.y}}drag(t,e,i){if(this.#t.x+=t.x,this.#t.y+=t.y,i){let h=T([this.#t.x,this.#t.y],i);t.x=h[0]-this.#e.x,t.y=h[1]-this.#e.y}t=L(t,this._origin,-this._shape.angle),t.x*=Math.sqrt(Math.pow(this._movement.x,2)),t.y*=Math.sqrt(Math.pow(this._movement.y,2));let n={x:t.x/2,y:t.y/2},r=L(n,this._origin,this._shape.angle);r.x+=n.x*(this._movement.x*-1),r.y+=n.y*(this._movement.y*-1),this._shape.moveBy(r),this._shape.scaleBy({x:t.x*this._movement.x,y:t.y*this._movement.y}),this.updatePosition(this._zoomLevel)}draw(t){this._drawSquareHandle(t,this._relativeHandleRect)}updatePosition(t){this.#e={x:this._shape.x+this._shape.width/2+this._movement.x*this._shape.width/2,y:this._shape.y+this._shape.height/2+this._movement.y*this._shape.height/2};let e={x:this._movement.x*this._shape.width/2*t,y:this._movement.y*this._shape.height/2*t};this._actualHandleRect=this._getHandleRect(this.#e),this._relativeHandleRect=this._getHandleRect(e)}},W=class extends A{constructor(t,e){super(t,{x:0,y:0},e),this.updatePosition(e)}drag(t,e){let i={x:e.xTrans-(this._shape.x+this._shape.width/2),y:e.yTrans-(this._shape.y+this._shape.height/2)},n=Math.atan2(i.y,i.x);this._shape.angle=n*180/Math.PI+90}draw(t){t.beginPath(),t.arc(this._relativePosition.x,this._relativePosition.y,5,0,Math.PI*2,!0),t.closePath(),t.fill(),t.stroke()}updatePosition(t){let e={x:this._shape.x+this._shape.width/2,y:this._shape.y-30/t};this._relativePosition={x:0,y:-this._shape.height/2*t-30},this._actualHandleRect=this._getHandleRect(e)}},v=class extends A{#t;#e;constructor(t,e,i){super(t,{x:0,y:0},e),this.center={x:0,y:0},this.updatePosition(e,i)}startDrag(){this.#t={x:this._shape.x,y:this._shape.y}}drag(t,e,i){if(i){this.#t.x+=t.x,this.#t.y+=t.y;var n=T([this.#t.x,this.#t.y],i);this._shape.x=n[0],this._shape.y=n[1]}else this._shape.x+=t.x,this._shape.y+=t.y;this.linkedPoint&&(this.linkedPoint.x=this._shape.x,this.linkedPoint.y=this._shape.y)}draw(t){this._drawSquareHandle(t,this._actualHandleRect)}updatePosition(t,e){this.#e={x:this._shape.x*t+e.x,y:this._shape.y*t+e.y},this._actualHandleRect=this._getHandleRect(this.#e),this.center={x:this.#e.x,y:this.#e.y}}};var E=class extends C{#t;#e;constructor(t,e,i){super(t,e,i),this.#e=[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0}],this.#t={x:0,y:0},this.drawBoundingBox=!1;for(let n=0;n<this.#e.length;n++)this._actualHandles.push(new O(this._shape,this.#e[n],e,this));this._shape.rotatable&&this._actualHandles.push(new W(this._shape,e)),this.updateHandles()}draw(t){t.save(),t.translate(this.#t.x,this.#t.y),this._shape.angle&&t.rotate(this._shape.angle*Math.PI/180),this.drawBoundingBox&&(t.strokeStyle="#666666",t.setLineDash([3,3]),t.lineWidth=1,t.strokeRect(-this._shape.width/2,-this._shape.height/2,this._shape.width,this._shape.height),t.setLineDash([])),super.draw(t),t.restore()}getHandleAtCoords(t){let e=L(t,this.#t,-this._shape.angle),i={x:(e.x-this.offset.x)/this.zoomLevel,y:(e.y-this.offset.y)/this.zoomLevel};for(var n=0;n<this._actualHandles.length;n++)if(this._actualHandles[n].hitTest(i))return this._actualHandles[n];return!1}updateHandles(){super.updateHandles(),this.#t={x:this._offset.x+(this._shape.x+this._shape.width/2)*this.zoomLevel,y:this._offset.y+(this._shape.y+this._shape.height/2)*this.zoomLevel}}};var w=class extends k{constructor(t,e,i,n,r,h,o,a,d){super(t,e,h,o,a,d),this.width=i,this.height=n,this.angle=r,this.handleMovements=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}]}getAdorner(){return new E(this)}hitTest(t,e){var i=L({x:t,y:e},{x:this.x+this.width/2,y:this.y+this.height/2},-this.angle);return i.x>=this.x&&i.x<=this.x+this.width&&i.y>=this.y&&i.y<=this.y+this.height}scaleBy(t){this.width+=t.x,this.height+=t.y}getExtents(){return{x:this.x,y:this.y,width:this.width,height:this.height}}getDataObject(){return{x:this.x,y:this.y,width:this.width,height:this.height,angle:this.angle,rotatable:!0}}_trasformContext(t){t.save(),t.translate(this.x+this.width/2,this.y+this.height/2),this.angle&&t.rotate(this.angle*Math.PI/180)}};var b=class extends C{getHandleAtCoords(t){for(var e=0;e<this._actualHandles.length;e++)if(this._actualHandles[e].hitTest({x:t.x,y:t.y}))return this._actualHandles[e];return!1}};var N=class extends b{constructor(t,e,i){super(t,e,i),this._actualHandles.push(new v(t.startPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endPoint,this.zoomLevel,this.offset)),this.updateHandles()}};var y=class s extends k{constructor(t,e,i,n,r,h,o,a){h=h??2,a=a??1,super(t,e,r||"#000",h,o||"Solid",a),this.startPoint={x:t,y:e},this.endPoint={x:i,y:n},this.type="Line"}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e,this.endPoint.x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e,this.endPoint.y+=e}getAdorner(){return new N(this)}draw(t){this._setStrokeStyle(t),t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y),t.lineCap="round",t.lineTo(this.endPoint.x,this.endPoint.y),t.stroke()}hitTest(t,e){let i,n,r=this.strokeThickness>4?this.strokeThickness:4;if(this.startPoint.x<=this.endPoint.x?(i=this.startPoint,n=this.endPoint):(n=this.startPoint,i=this.endPoint),t+r<i.x||n.x<t-r||e+r<Math.min(i.y,n.y)||Math.max(i.y,n.y)<e-r)return!1;let h={x:n.x-i.x,y:n.y-i.y};if(h.x==0||h.y==0)return!0;let o=h.y/h.x,a=i.y-i.x*o,d=t*o+a;return e-r<=d&&d<=e+r}getExtents(){let t,e,i,n;return this.startPoint.x<this.endPoint.x?(t=this.startPoint.x,e=this.endPoint.x):(e=this.startPoint.x,t=this.endPoint.x),this.startPoint.y<this.endPoint.y?(i=this.startPoint.y,n=this.endPoint.y):(n=this.startPoint.y,i=this.endPoint.y),{x:t,y:i,width:e-t,height:n-i}}flip(){let t=this.startPoint;this.startPoint=this.endPoint,this.endPoint=t}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,x2:this.endPoint.x,y2:this.endPoint.y,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness}}static Deserialize=function(t){return new s(t.x,t.y,t.x2,t.y2,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var G=class s extends w{constructor(t,e,i,n,r,h,o,a,d,c,u){a=a??2,c=c??1,super(t,e,i,n,r,o||"#000",a,d||"Solid",c),this.fill=h||"#fff",this.cleanFill=u||!1,this.type="Rectangle"}hitTest(t,e){if(this.fill=="rgba(0,0,0,0)"||this.fill=="transparent")return this.strokeHitTest(t,e);super.hitTest(t,e)}strokeHitTest(t,e){var i=L({x:t,y:e},{x:this.x+this.width/2,y:this.y+this.height/2},-this.angle),n=this.x,r=this.x+this.width,h=this.y,o=this.y+this.height;if(i.x<n||i.x>r||i.y<h||i.y>o)return!1;let a=this.strokeThickness*1.5;return i.x>=n-a&&i.x<=n+a&&i.y>=h&&i.y<=o||i.x>=r-a&&i.x<=r+a&&i.y>=h&&i.y<=o||i.y>=h-a&&i.y<=h+a&&i.x>=n&&i.x<=r||i.y>=o-a&&i.y<=o+a&&i.x>=n&&i.x<=r}draw(t){this._trasformContext(t),t.fillStyle=this.fill,t.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.strokeRect(-this.width/2,-this.height/2,this.width,this.height)),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.strokeColor=this.stroke,t.strokeThickness=this.strokeThickness,t.strokeType=this.strokeType,t.strokeRoughness=this.strokeRoughness,t.cleanFill=this.cleanFill,t}breakApart(){return[new s(this.x,this.y,this.width,this.height,this.angle,this.fill,"rgba(0,0,0,0)",0,this.strokeType,0,this.cleanFill),new y(this.x,this.y,this.x+this.width,this.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new y(this.x+this.width,this.y,this.x+this.width,this.y+this.height,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new y(this.x+this.width,this.y+this.height,this.x,this.y+this.height,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness),new y(this.x,this.y+this.height,this.x,this.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness)]}static Deserialize(t){return new s(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness,t.cleanFill)}};var U=class s extends w{constructor(t,e,i,n,r,h,o,a,d,c){a=a??2,c=c??1,super(t,e,i,n,r,o||"#000",a,d||"Solid",c),this.fill=h||"#fff",this.type="Ellipse"}draw(t){this._trasformContext(t),t.fillStyle=this.fill;var e=-this.width/2,i=-this.height/2,n=this.width,r=this.height,h=.5522848,o=n/2*h,a=r/2*h,d=e+n,c=i+r,u=e+n/2,p=i+r/2;t.beginPath(),t.moveTo(e,p),t.bezierCurveTo(e,p-a,u-o,i,u,i),t.bezierCurveTo(u+o,i,d,p-a,d,p),t.bezierCurveTo(d,p+a,u+o,c,u,c),t.bezierCurveTo(u-o,c,e,p+a,e,p),t.closePath(),t.fill(),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.stroke()),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.strokeColor=this.stroke,t.strokeThickness=this.strokeThickness,t.strokeType=this.strokeType,t.strokeRoughness=this.strokeRoughness,t}static Deserialize(t){return new s(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var q=class s extends w{constructor(t,e,i,n,r,h,o,a){super(t,e,i,n,r),this.fill=h||"#000000",this.text=o||"Text",this.fontSize=a||12,this.type="Text"}getAdorner(){let t=new E(this);return t.drawBoundingBox=!0,t}draw(t){if(this._trasformContext(t),t.fillStyle=this.fill,t.font=this.fontSize+"px Arial",t.textBaseline="hanging",this.width===0||this.height===0){var e=t.measureText(this.text);this.width=e.width,this.height=this.#t()}t.rect(-this.width/2,-this.height/2,this.width,this.height),t.clip(),this.#e(t,this.text,-this.width/2,-this.height/2+this.#t(),this.width,this.#t()),t.restore()}getDataObject(){var t=super.getDataObject();return t.fillColor=this.fill,t.content=this.text,t.fontSize=this.fontSize,t}static Deserialize(t){return new s(t.x,t.y,t.width,t.height,t.angle,t.fillColor,t.content,t.fontSize)}#t(){return Math.ceil(this.fontSize*1.15)}#e(t,e,i,n,r,h){let o=e.split(" "),a="";n-=h-1;for(let p=0;p<o.length;p++){var d=a+(a.length>0?" ":"")+o[p],c=t.measureText(d),u=c.width;u>r&&p>0?(t.fillText(a,i,n),a=o[p],n+=h):a=d}t.fillText(a,i,n)}};var X=class s extends w{#t;#e;constructor(t,e,i,n,r,h){super(t,e,i,n,r),this.#e=!1,this.#t=new Image;let o=this;this.#t.onload=function(){o.#e=!0},this.#t.src=h,this.type="Picture"}draw(t){this._trasformContext(t),this.#e?t.drawImage(this.#t,-this.width/2,-this.height/2,this.width,this.height):(t.fillStyle="#ffffff",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle="#000000",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.strokeStyle="#ff0000",t.beginPath(),t.moveTo(-this.width*.7/2,-this.height*.7/2),t.lineTo(this.width*.7/2,this.height*.7/2),t.moveTo(this.width*.7/2,-this.height*.7/2),t.lineTo(-this.width*.7/2,this.height*.7/2),t.closePath(),t.lineWidth=.5,t.stroke()),t.restore()}getDataObject(){var t=super.getDataObject();return t.imgsrc=this.#t.src,t}static Deserialize(t){return new s(t.x,t.y,t.width,t.height,t.angle,t.imgsrc)}};var j=class extends b{constructor(t,e,i){super(t,e,i),this._actualHandles.push(new v(t.startPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.startControlPoint,this.zoomLevel,this.offset)),this._actualHandles.push(new v(t.endControlPoint,this.zoomLevel,this.offset)),this.updateHandles()}draw(t){t.strokeStyle="#cc4444",t.lineWidth=1,t.beginPath(),t.moveTo(this._actualHandles[0].center.x,this._actualHandles[0].center.y),t.lineTo(this._actualHandles[2].center.x,this._actualHandles[2].center.y),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this._actualHandles[1].center.x,this._actualHandles[1].center.y),t.lineTo(this._actualHandles[3].center.x,this._actualHandles[3].center.y),t.closePath(),t.stroke(),super.draw(t)}};var _=class s extends k{constructor(t,e,i,n,r,h,o,a,d,c,u,p){c=c??2,p=p??1,super(t,e,d||"#000",c,u||"Solid",p),this.startPoint={x:t,y:e},this.endPoint={x:i,y:n},this.startControlPoint={x:r,y:h},this.endControlPoint={x:o,y:a},this.type="BezierLine"}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e,this.endPoint.x+=e,this.startControlPoint.x+=e,this.endControlPoint.x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e,this.endPoint.y+=e,this.startControlPoint.y+=e,this.endControlPoint.y+=e}getAdorner(){return new j(this)}draw(t){this._setStrokeStyle(t),t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y),t.bezierCurveTo(this.startControlPoint.x,this.startControlPoint.y,this.endControlPoint.x,this.endControlPoint.y,this.endPoint.x,this.endPoint.y),t.stroke()}hitTest(t,e){let i=Math.max(this.startPoint.x,this.endPoint.x,this.startControlPoint.x,this.endControlPoint.x),n=Math.max(this.startPoint.y,this.endPoint.y,this.startControlPoint.y,this.endControlPoint.y),r=document.createElement("canvas");r.width=i,r.height=n;let h=r.getContext("2d");h.lineWidth=10,h.strokeStyle="#ff0000",h.beginPath(),h.moveTo(this.startPoint.x,this.startPoint.y),h.bezierCurveTo(this.startControlPoint.x,this.startControlPoint.y,this.endControlPoint.x,this.endControlPoint.y,this.endPoint.x,this.endPoint.y),h.stroke();var o=h.getImageData(t,e,1,1);return o.data[0]==255&&o.data[1]==0&&o.data[2]==0}getExtents(){let t,e,i,n;return this.startPoint.x<this.endPoint.x?(t=this.startPoint.x,e=this.endPoint.x):(e=this.startPoint.x,t=this.endPoint.x),this.startPoint.y<this.endPoint.y?(i=this.startPoint.y,n=this.endPoint.y):(n=this.startPoint.y,i=this.endPoint.y),{x:t,y:i,width:e-t,height:n-i}}flip(){let t=this.startPoint;this.startPoint=this.endPoint,this.endPoint=t;let e=this.startControlPoint;this.startControlPoint=this.endControlPoint,this.endControlPoint=e}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,x2:this.endPoint.x,y2:this.endPoint.y,cx1:this.startControlPoint.x,cy1:this.startControlPoint.y,cx2:this.endControlPoint.x,cy2:this.endControlPoint.y,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness}}static Deserialize=function(t){return new s(t.x,t.y,t.x2,t.y2,t.cx1,t.cy1,t.cx2,t.cy2,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness)}};var Y=class extends b{constructor(t,e,i){super(t,e,i);let n=new v(t.startPoint,this.zoomLevel,this.offset);this._actualHandles.push(n);for(var r=0;r<t.remainingPoints.length;r++)r==t.remainingPoints.length-1&&t.remainingPoints[r].x==t.startPoint.x&&t.remainingPoints[r].y==t.startPoint.y?n.linkedPoint=t.remainingPoints[r]:this._actualHandles.push(new v(t.remainingPoints[r],this.zoomLevel,this.offset));this.updateHandles()}draw(t){t.strokeStyle="#cc4444",t.lineWidth=1;for(var e=1;e<this._actualHandles.length;e+=3){t.beginPath(),t.moveTo(this._actualHandles[e-1].center.x,this._actualHandles[e-1].center.y),t.lineTo(this._actualHandles[e].center.x,this._actualHandles[e].center.y),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(this._actualHandles[e+1].center.x,this._actualHandles[e+1].center.y);let i=e+2==this._actualHandles.length?0:e+2;t.lineTo(this._actualHandles[i].center.x,this._actualHandles[i].center.y),t.closePath(),t.stroke()}super.draw(t)}};var V=class s extends k{constructor(t,e,i,n,r,h,o,a,d){h=h??2,a=a??1,super(t,e,r||"#000",h,o||"Solid",a),this.startPoint={x:t,y:e},this.remainingPoints=i,this.fill=n||"rgba(0,0,0,0)",this.type="BezierPoly",this.cleanFill=d||!1}get x(){return this.startPoint?.x}set x(t){if(!this.startPoint)return;let e=t-this.x;this.startPoint.x+=e;for(let i=0;i<this.remainingPoints.length;i++)this.remainingPoints[i].x+=e}get y(){return this.startPoint?.y}set y(t){if(!this.startPoint)return;let e=t-this.y;this.startPoint.y+=e;for(let i=0;i<this.remainingPoints.length;i++)this.remainingPoints[i].y+=e}getAdorner(){return new Y(this)}draw(t){t.beginPath(),t.moveTo(this.startPoint.x,this.startPoint.y);for(var e=0;e<this.remainingPoints.length/3;e++){let i=this.remainingPoints[e*3],n=this.remainingPoints[e*3+1],r=this.remainingPoints[e*3+2];t.bezierCurveTo(i.x,i.y,n.x,n.y,r.x,r.y)}t.closePath(),t.fillStyle=this.fill,t.fill(),this.stroke&&this.strokeThickness>0&&(this._setStrokeStyle(t),t.stroke())}hitTest(t,e){let i=this.remainingPoints.map(function(u){return u.x});i.push(this.startPoint.x);let n=this.remainingPoints.map(function(u){return u.y});n.push(this.startPoint.y);let r=Math.max(...i),h=Math.max(...n),o=document.createElement("canvas");o.width=r,o.height=h;let a=o.getContext("2d");a.lineWidth=10,a.strokeStyle="#ff0000",a.fillStyle="#ff0000",a.beginPath(),a.moveTo(this.startPoint.x,this.startPoint.y);for(var d=0;d<this.remainingPoints.length/3;d++){let u=this.remainingPoints[d*3],p=this.remainingPoints[d*3+1],g=this.remainingPoints[d*3+2];a.bezierCurveTo(u.x,u.y,p.x,p.y,g.x,g.y)}a.fill(),a.stroke();var c=a.getImageData(t,e,1,1);return c.data[0]==255&&c.data[1]==0&&c.data[2]==0}getExtents(){let t=this.remainingPoints.map(function(o){return o.x});t.push(this.startPoint.x);let e=this.remainingPoints.map(function(o){return o.y});e.push(this.startPoint.y);let i=Math.min(...t),n=Math.max(...t),r=Math.min(...e),h=Math.max(...e);return{x:i,y:r,width:n-i,height:h-r}}breakApart(){let t=[new s(this.x,this.y,this.remainingPoints,this.fill,"rgba(0,0,0,0)",null,null,null,this.cleanFill)],e=this.startPoint;for(var i=0;i<this.remainingPoints.length/3;i++){let n=this.remainingPoints[i*3],r=this.remainingPoints[i*3+1],h=this.remainingPoints[i*3+2];t.push(new _(e.x,e.y,h.x,h.y,n.x,n.y,r.x,r.y,this.stroke,this.strokeThickness,this.strokeType,this.strokeRoughness)),e=h}return t}getDataObject(){return{x:this.startPoint.x,y:this.startPoint.y,remainingPoints:this.remainingPoints,fillColor:this.fill,strokeColor:this.stroke,strokeThickness:this.strokeThickness,strokeType:this.strokeType,strokeRoughness:this.strokeRoughness,cleanFill:this.cleanFill}}static Deserialize=function(t){return new s(t.x,t.y,t.remainingPoints,t.fillColor,t.strokeColor,t.strokeThickness,t.strokeType,t.strokeRoughness,t.cleanFill)}};var K=class extends C{constructor(t,e,i){super(t,e,i)}draw(t){let e=this._shape.x*this.zoomLevel+this.offset.x,i=this._shape.y*this.zoomLevel+this.offset.y,n=this._shape.width*this.zoomLevel,r=this._shape.height*this.zoomLevel;t.strokeStyle="#fff",t.setLineDash([3,3]),t.lineWidth=1,t.strokeRect(e,i,n,r),t.setLineDash([])}getHandleAtCoords(t){return!1}};var z=class s extends w{#t;constructor(t){super(0,0,0,0,0),this.#t=t||[];let e=this.getMaxExtents();this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.type="GroupedShapes"}get shapes(){return this.#t}getAdorner(){return new K(this)}moveBy(t,e){let i=this.x,n=this.y;super.moveBy(t,e);let r=this.x-i,h=this.y-n;for(let o=0;o<this.#t.length;o++)this.#t[o].x+=r,this.#t[o].y+=h}scaleBy(t){super.scaleBy(t);for(let e=0;e<this.#t.length;e++)this.#t[e].width+=t.y,this.#t[e].height+=t.y}draw(t){for(let e=0;e<this.#t.length;e++)this.#t[e].draw(t)}hitTest(t,e){for(let i=this.#t.length-1;i>=0;i--)if(this.#t[i].hitTest(t,e))return this.#t[i];return!1}getMaxExtents(){if(this.#t.length==0)return{x:0,y:0,width:0,height:0};let t=this.#t[0].getExtents();for(let e=1;e<this.#t.length;e++)t=H(t,this.#t[e].getExtents());return t}breakApart(){return this.#t}getDataObject(){for(var t=[],e=0;e<this.#t.length;e++)t.push(this.#t[e].serialize());return t}static Deserialize(t){let e=[];for(let i=0;i<t.length;i++){let n=t[i].type;if(!n||!t[i].data)continue;let r=JSON.parse(t[i].data),h=J(n,r);h&&e.push(h)}return new s(e)}};var H=function(s,t){var e={};return e.x=s.x<t.x?s.x:t.x,e.y=s.y<t.y?s.y:t.y,e.width=(s.x+s.width>t.x+t.width?s.x+s.width:t.x+t.width)-e.x,e.height=(s.y+s.height>t.y+t.height?s.y+s.height:t.y+t.height)-e.y,e},L=function(s,t,e){return e=e*Math.PI/180,{x:Math.cos(e)*(s.x-t.x)-Math.sin(e)*(s.y-t.y)+t.x,y:Math.sin(e)*(s.x-t.x)+Math.cos(e)*(s.y-t.y)+t.y}},T=function(s,t){for(var e=0;e<s.length;e++){var i=s[e],n=Math.floor(i/t)*t,r=Math.ceil(i/t)*t;s[e]=i-n<r-i?n:r}return s},J=function(s,t){let e=null;switch(s){case"Rectangle":e=G.Deserialize(t);break;case"Ellipse":e=U.Deserialize(t);break;case"Line":e=y.Deserialize(t);break;case"Text":e=q.Deserialize(t);break;case"XImage":case"Picture":e=X.Deserialize(t);break;case"BezierLine":e=_.Deserialize(t);break;case"BezierPoly":e=V.Deserialize(t);break;case"GroupedShapes":e=z.Deserialize(t);break}return e};var $=class{#t;#e;constructor(){this.#t={},this.#e=[]}set zoomLevel(t){Object.keys(this.#t).forEach(function(e){this.#t[e].zoomLevel=t})}set offset(t){Object.keys(this.#t).forEach(function(e){this.#t[e].offset=t})}addAdorner(t,e){this.#e.indexOf(t)>-1||(this.#e.push(t),this.#t[this.#e.length-1]=e)}removeAdorner(t){let e=this.#e.indexOf(t);if(e!=-1){this.#e.splice(e,1),delete this.#t[e];var i={},n=0;for(var r in this.#t)i[n]=this.#t[r],n++;this.#t=i}}getAdonerForShape(t){let e=this.#e.indexOf(t);return this.#t[e]}getAdornerHandleAtCoords(t){for(var e in this.#t){var i=this.#t[e].getHandleAtCoords(t);if(i)return i}return null}updateHandles(){for(var t in this.#t)this.#t[t].updateHandles()}clear(){this.#t={},this.#e=[]}draw(t){for(var e in this.#t)this.#t[e].draw(t)}};var Q=class{#t;#e;#n;#i;#r;#o;#a;#l;#d;#s;#h;constructor(t){this.#t=t,this.width=this.#t.width,this.height=this.#t.height,this.#e=new R(this.#t),this.#n=this.#e.context,this.shapeLayers=[],this.snapToGrid=!1,this.grid=null,this.extent=null,this.#s=[],this.#d=[],this.#a=[],this.#h=[],this.adorners=new $,this.zoomLevel=1,this.offset={x:0,y:0},this.gridColour="rgba(0,100,255,0.1)",this.backgroundColour=null,this.#l=new S(this);let e=this;t.addEventListener("mousedown",i=>{i.preventDefault();let n=e.#c(i);e.activeTool?.mouseDown(n)}),t.addEventListener("mousemove",i=>{let n=e.#c(i);e.activeTool?.mouseMove(n)}),t.addEventListener("mouseup",i=>{let n=e.#c(i);e.activeTool?.mouseUp(n)}),window.requestAnimationFrame(function(i){return function(){i.#u()}}(this))}get offset(){return this.#i}set offset(t){this.#i=t,this.adorners.offset=t}get zoomLevel(){return this.#r}set zoomLevel(t){this.#r=t,this.adorners.zoomLevel=t}get activeTool(){return this.#l}set activeTool(t){this.#l=t,this.#d.forEach(e=>e(t)),this.deselectAllShapes()}get activeLayer(){return this.#o}set activeLayer(t){let e=this;this.#o=t,this.#o.contentsChangedCallback=()=>{e.updated()}}get selectedShapes(){return this.#s}updated(){this.#a.forEach(t=>t())}selectShape(t){if(!t||this.#s.indexOf(t)>-1)return;this.#s.push(t);let e=t.getAdorner();e.zoomLevel=this.zoomLevel,e.offset=this.offset,this.adorners.addAdorner(t,e),this.#h.forEach(i=>i(t))}startDragSelectedShapes(){for(let t=0;t<this.#s.length;t++)this.#s[t].startDrag()}selectShapesInRect(t){let e=this.activeLayer.getShapesInRect(t);for(let i=0;i<e.length;i++)this.selectShape(e[i])}deselectShape(t){let e=this.#s.indexOf(t);e!=-1&&(this.#s.splice(e,1),this.adorners.removeAdorner(t),this.#h.forEach(i=>i(null)))}deselectAllShapes(){for(let t=0;t<this.#s.length;t++)this.#s[t].selected=!1;this.#s=[],this.adorners.clear(),this.#h.forEach(t=>t(null))}shapeIsSelected(t){return this.#s.indexOf(t)>-1}moveSelectedShapesBy(t,e){for(let i=0;i<this.#s.length;i++)this.#s[i].moveBy(t,e);this.adorners.updateHandles(),this.updated()}deleteSelectedShapes(){for(let t=0;t<this.#s.length;t++)this.activeLayer.removeShape(this.#s[t]);this.deselectAllShapes(),this.updated()}breakApartSelectedShapes(){for(let t=0;t<this.#s.length;t++){let e=this.#s[t],i=e.breakApart();for(let n=0;n<i.length;n++)this.activeLayer.add(i[n]);i.length>0&&this.activeLayer.removeShape(e)}this.deselectAllShapes(),this.updated()}groupSelectedShapes(){let t=new z(this.#s);this.deleteSelectedShapes(),this.activeLayer.add(t),this.selectShape(t),this.updated()}duplicateSelectedShapes(){let t=new z(this.#s),e=z.Deserialize(JSON.parse(t.serialize().data));this.deselectAllShapes();for(let i=0;i<e.shapes.length;i++)this.activeLayer.add(e.shapes[i]),this.selectShape(e.shapes[i]);this.moveSelectedShapesBy({x:10,y:10},this.snapToGrid?this.grid:null),this.updated()}moveSelectedShapesUp(){for(let t=0;t<this.#s.length;t++)this.activeLayer.moveShapeUp(this.#s[t]);this.updated()}moveSelectedShapesDown(){for(let t=0;t<this.#s.length;t++)this.activeLayer.moveShapeDown(this.#s[t]);this.updated()}nudgeSelectedShapes(t){if(this.#s.length==0)return;let e={x:t.x,y:t.y};if(this.snapToGrid&&this.grid){let i=this.#s[0],n=T([i.x,i.y],this.grid),r=t.x!=0?n[0]-i.x:0,h=t.y!=0?n[1]-i.y:0;e.x=(t.x/Math.abs(t.x)||0)*this.grid+r,e.y=(t.y/Math.abs(t.y)||0)*this.grid+h}for(let i=0;i<this.#s.length;i++)this.#s[i].moveBy(e);this.adorners.updateHandles(),this.updated()}getMaxExtents(){if(this.shapeLayers.length==0)return{x:0,y:0,width:0,height:0};let t=this.shapeLayers[0].getMaxExtents();for(let e=1;e<this.shapeLayers.length;e++)t=H(t,this.shapeLayers[e].getMaxExtents());return t}centreContent(){let t=this.getMaxExtents(),e={x:(this.#t.width()-t.width*this.#r)/2,y:(this.#t.height()-t.height*this.#r)/2};this.offset=e}zoomToExtents(){let t=this.getMaxExtents(),e=this.#t.width()/t.width,i=this.#t.height()/t.height,n=e>i?i:e;this.zoomLevel=n,this.centreContent()}addActiveToolChangedListener(t){this.#d.push(t)}addActiveLayerUpdatedListener(t){this.#a.push(t)}addSelectedShapesChangedListener(t){this.#h.push(t)}#u(){this.#n.clearRect(0,0,this.width,this.height),this.backgroundColour&&(this.#n.fillStyle=this.backgroundColour,this.#n.fillRect(0,0,this.width,this.height)),this.#n.save(),this.#n.translate(this.#i.x,this.#i.y),this.#n.scale(this.#r,this.#r),this.#f(),this.#p();for(var t=0;t<this.shapeLayers.length;t++)this.shapeLayers[t].draw(this.#n);this.#n.restore(),this.adorners.draw(this.#n),this.selectionRect&&(this.#n.save(),this.#n.strokeStyle="#fff",this.#n.setLineDash([5,5]),this.#n.lineWidth=1,this.#n.strokeRect(this.selectionRect.x,this.selectionRect.y,this.selectionRect.width,this.selectionRect.height),this.#n.restore()),window.requestAnimationFrame(function(e){return function(){e.#u()}}(this))}#f(){if(this.grid){var t=this.#n;t.strokeStyle=this.gridColour,t.lineWidth=1,t.setLineDash([]);for(var e=0;e<=this.width;e+=this.grid)t.beginPath(),t.moveTo(e,0),t.lineTo(e,this.height),t.closePath(),t.stroke();for(var i=0;i<=this.height;i+=this.grid)t.beginPath(),t.moveTo(0,i),t.lineTo(this.width,i),t.closePath(),t.stroke()}}#p(){var t=this.#n;if(this.origin&&(t.strokeStyle="rgba(255,0,0,0.2)",t.lineWidth=1,t.beginPath(),t.moveTo(this.origin.x,0),t.lineTo(this.origin.x,this.height),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(0,this.origin.y),t.lineTo(this.width,this.origin.y),t.closePath(),t.stroke()),this.extent){let e=this.origin.x>this.width/4?-this.extent:this.extent;t.strokeStyle="rgba(0,200,0,0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(this.origin.x+e,0),t.lineTo(this.origin.x+e,this.height),t.closePath(),t.stroke()}}#c(t){var e={x:t.pageX-this.#t.offsetLeft,y:t.pageY-this.#t.offsetTop,shiftKey:t.shiftKey};return this.#y(e)}#y(t){return t.xTrans=(t.x-this.#i.x)/this.#r,t.yTrans=(t.y-this.#i.y)/this.#r,t}};var I=class s{contentsChangedCallback=null;#t;constructor(t){this.#t=t||[],this.opacity=1}get length(){return this.#t.length}get shapes(){return this.#t}add(t){this.#t.push(t),this.contentsChangedCallback&&this.contentsChangedCallback(this)}draw(t){t.globalAlpha=this.opacity;for(let e=0;e<this.#t.length;e++)this.#t[e].draw(t);t.globalAlpha=1}hitTest(t,e){for(let i=this.#t.length-1;i>=0;i--)if(this.#t[i].hitTest(t,e))return this.#t[i];return!1}getShapeIndex(t){let e=-1;for(let i=this.#t.length-1;i>=0;i--)if(this.#t[i]===t){e=i;break}return e}containsShape(t){return this.getShapeIndex(t)>-1}removeShape(t){let e=this.getShapeIndex(t);this.#t.splice(e,1),this.contentsChangedCallback&&this.contentsChangedCallback(this)}moveShapeUp(t){let e=this.getShapeIndex(t);e!==this.#t.length-1&&(this.#t.splice(e,1),this.#t.push(t),this.contentsChangedCallback&&this.contentsChangedCallback(this))}moveShapeDown(t){let e=this.getShapeIndex(t);e!==0&&(this.#t.splice(e,1),this.#t.splice(e-1,0,t),this.contentsChangedCallback&&this.contentsChangedCallback(this))}getShapesInRect(t){let e=[];for(let i=0;i<this.#t.length;i++){let n=this.#t[i].getExtents();n.x<t.x+t.width&&n.x+n.width>t.x&&n.y<t.y+t.height&&n.y+n.height>t.y&&e.push(this.#t[i])}return e}getMaxExtents(){if(this.#t.length==0)return{x:0,y:0,width:0,height:0};let t=this.#t[0].getExtents();for(let e=1;e<this.#t.length;e++)t=H(t,this.#t[e].getExtents());return t}serialize(){let t=[];for(let e=0;e<this.#t.length;e++)t.push(this.#t[e].serialize());return t}static Deserialize(t){let e=new s;for(let i=0;i<t.length;i++){let n=t[i].type;if(!n||!t[i].data)continue;let r=JSON.parse(t[i].data),h=J(n,r);h&&e.add(h)}return e}};var Z=class extends B{constructor(t){super(t),this._grid=t.snapToGrid?t.grid:null}mouseDown(t){super.mouseDown(t),this._snapToGrid(t)}_snapToGrid(t){if(this._grid){var e=T([t.xTrans,t.yTrans],this._grid);t.xTrans=e[0],t.yTrans=e[1]}}};var F=class extends Z{constructor(t,e,i){super(t),this._lineToAdd=new y(0,0,0,0,e.strokeColor,e.strokeThickness,e.strokeType),this._line=null,this._keepDrawing=i&&i.keepDrawing||!1}mouseMove(t){if(this._mouseButtonDown){var e={x:t.x-this._lastMouseCoords.x,y:t.y-this._lastMouseCoords.y};this._snapToGrid(t),!this._line&&(Math.abs(e.x)>20||Math.abs(e.y)>20)&&(this._line=this._lineToAdd,this._dc.activeLayer.add(this._line),this._line.startPoint.x=this._lastMouseCoords.xTrans,this._line.startPoint.y=this._lastMouseCoords.yTrans),this._line&&(this._line.endPoint.x=t.xTrans,this._line.endPoint.y=t.yTrans)}}mouseUp(t){super.mouseUp(t),this._line&&(this._dc.updated(),this._keepDrawing?(this._lineToAdd=new y(0,0,0,0,this._line.stroke,this._line.strokeThickness,this._line.strokeType),this._line=null):(this._dc.activeTool=new S(this._dc),this._dc.selectShape(this._line)))}};var tt=class extends F{constructor(t,e){super(t,e),this._lineToAdd=new _(0,0,0,0,0,0,0,0,e.strokeColor,e.strokeThickness,e.strokeType)}mouseMove(t){if(super.mouseMove(t),this._mouseButtonDown&&this._line){let e={x:this._line.startPoint.x+(this._line.endPoint.x-this._line.startPoint.x)/3,y:this._line.startPoint.y+(this._line.endPoint.y-this._line.startPoint.y)/3},i={x:this._line.startPoint.x+(this._line.endPoint.x-this._line.startPoint.x)*2/3,y:this._line.startPoint.y+(this._line.endPoint.y-this._line.startPoint.y)*2/3};this._line.startControlPoint=e,this._line.endControlPoint=i}}};var M={_modalsInititalized:!1,_currentModalNoClose:!1,showModal:function(s,t){let e=document.getElementById(s),i=document.getElementById("modalOverlay");if(i.appendChild(e),i.style.display="flex",this._currentModalNoClose=t,this._modalsInititalized)return;this._modalsInititalized=!0;let n=document.querySelectorAll(".modal .close-button");i.addEventListener("click",r=>{r.target===i&&!this._currentModalNoClose&&M.hideModal()}),n.forEach(r=>{r.addEventListener("click",()=>{M.hideModal()})})},hideModal:function(s){let t=document.getElementById("modalOverlay"),e=document.querySelectorAll("#modalOverlay .modal")[0],i=document.getElementById("modals");t.style.display="none",t.removeChild(e),i.appendChild(e)},makeEditable:function(s,t){let e=this;s.addEventListener("click",i=>{i.target==s&&e._editText(s,n=>{let r=s.innerText;s.innerText=n,t(n,r)})})},_editText:function(s,t){let e=document.createElement("input");e.style.width="80px",e.value=s.innerText,s.innerText="",s.appendChild(e),e.focus(),e.addEventListener("blur",()=>{s.innerText=e.value,t(e.value)}),e.addEventListener("keydown",i=>{i.key=="Enter"&&(s.innerText=e.value,t(e.value))})}};var m={_fonts:null,loadFonts:function(){if(this._fonts===null){let s=localStorage.getItem("fonts");s?s=JSON.parse(s):s=[],this._fonts=s}return this._fonts},loadFontByName:function(s){let t=this.loadFonts();for(let e=0;e<t.length;e++){let i=t[e];if(i.name==s)return i}return null},saveFonts:function(s){this._fonts=s,localStorage.setItem("fonts",JSON.stringify(s))},importFontFromCode:function(s,t){let e=/\s{'(.)',\s\(const\suint8_t\[\]\)\s?{[^}]*},[^}]*},/gm,i=[...t.matchAll(e)],n={name:s,letters:[]};if(i)for(let r=0;r<i.length;r++){let h=i[r],o=h[1],a=h[0];n.letters.push({letter:o,code:a})}else return!1;return this._fonts.push(n),this.saveFonts(this._fonts),!0},exportFontCode:function(s){let t="";for(let e=0;e<s.letters.length;e++){let i=s.letters[e];t+=i.code+`
`}return t=t.replace(/,\s*$/,""),t},serializeLetter:function(s,t,e,i,n){let r=this._serializeLines(t,i,n),h=(r.length+2)/6;return"  {'"+s+"', (const uint8_t[]){ "+r+" }, "+h+", "+e+"},"},deserializeLetter:function(s,t,e,i,n){let r=/\s?{'(.)', \(const uint8_t\[\]\){ ((?:0x[A-Fa-f0-9]{2},? )+)}, (\d+), (\d+)}/gm,h=r.exec(s),o={letter:"",hexString:"",letterWidth:0,shapes:[],og:!1};if(h==null){r=/{((?:\s*\d+,?)+)\s*}/gm;let a=r.exec(s);if(a==null)return null;o.hexString=a[1],o.shapes=this._deserializeOgLines(o.hexString,t,e,i,n),o.og=!0}else o.letter=h[1],o.hexString=h[2],o.letterWidth=h[4],o.shapes=this._deserializeLines(o.hexString,t,e,i,n);return o},_serializeLines:function(s,t,e){let i=[];if(s.length==0)return"0x00";s=s.map(l=>l instanceof y?{startPoint:l.startPoint,endPoint:l.endPoint}:l instanceof _?{startPoint:l.startPoint,endPoint:l.endPoint,startControlPoint:l.startControlPoint,endControlPoint:l.endControlPoint}:null).filter(l=>l!==null);var n=function(l){let f=[];for(let P=0;P<s.length;P++){let x=s[P];i.includes(x)==!1&&x.startPoint.x==l.x&&x.startPoint.y==l.y&&f.push(x),i.includes(x)==!1&&x.endPoint.x==l.x&&x.endPoint.y==l.y&&f.push(x)}return f};let r=[];for(let l=0;l<s.length;l++){let f=s[l],P=n(f.startPoint),x=n(f.endPoint);r.push({index:l,line:f,startShapes:P.length,endShapes:x.length})}r=r.filter(l=>l.startShapes==1||l.endShapes==1);let h=Number.MAX_VALUE,o=null;for(let l=0;l<r.length;l++){let f=r[l],P=Math.sqrt(Math.pow(f.line.startPoint.x,2)+Math.pow(f.line.startPoint.y,2));P<h&&(h=P,o=f)}let a=function(l){let f=l.startPoint;l.startPoint=l.endPoint,l.endPoint=f,l.startControlPoint&&(f=l.startControlPoint,l.startControlPoint=l.endControlPoint,l.endControlPoint=f)},d=function(l){let f=l,P=null;do{P=n(f);for(let x=0;x<P.length;x++){let D=P[x];if(i.includes(D)==!1){(D.startPoint.x!=f.x||D.startPoint.y!=f.y)&&a(D),i.push(D),f=D.endPoint;break}}}while(P.length>0)};if(i=[],o!=null)i.push(o.line),o.startShapes>1&&a(o.line),d(o.line.endPoint);else{let l=s[0];i.push(l),d(l.endPoint)}for(let l=0;l<s.length;l++){let f=s[l];i.includes(f)==!1&&(i.push(f),d(f.endPoint))}let c=new et,u=function(l){c.append(parseInt(l.x/t),4),c.append(parseInt(e-1-l.y/t),4)},p={x:0,y:0};for(let l=0;l<i.length;l++){let f=i[l];(f.startPoint.x!=p.x||f.startPoint.y!=p.y)&&(c.append(0,1),c.append(0,1),u(f.startPoint)),f.startControlPoint||(c.append(1,1),c.append(0,1),u(f.endPoint)),f.startControlPoint&&(c.append(1,1),c.append(1,1),u(f.endPoint),u(f.startControlPoint),u(f.endControlPoint)),p=f.endPoint}let g=c.serializeToHex();return g=g.substring(0,g.length-2),g},_deserializeLines:function(s,t,e,i,n){let r=[],h={x:0,y:0},o=new it(s),a=function(){return{x:o.read(4)*t,y:(e-1-o.read(4))*t}};for(;o.eof==!1;){let d=o.read(1),c=o.read(1),u=a();if(d==1)if(c==0){let p=new y(h.x,h.y,u.x,u.y,i,n);r.push(p)}else{let p=a(),g=a(),l=new _(h.x,h.y,u.x,u.y,p.x,p.y,g.x,g.y,i,n);r.push(l)}h=u}return r},_deserializeOgLines:function(s,t,e,i,n){let r=s.split(",").map(a=>parseInt(a.trim())),h=[],o={x:0,y:0};for(let a=0;a<r.length;a++){let d=r[a];if(d==200)break;let c=0;d>99&&(c=1,d-=100);let u=parseInt(d/10),p=d-u*10;u*=3,p*=3;let g={x:u*t,y:(e-1-p)*t};if(c==1){let l=new y(o.x,o.y,g.x,g.y,i,n);h.push(l)}o=g}return h}},et=class{constructor(){this.bytes=[0],this.nextBit=0,this.currentByteIndex=0,this.totalBits=0}append(t,e){let i=this.bytes[this.currentByteIndex],n=8-this.nextBit-e,r=n<0?t>>>n*-1:t<<n,h=i|r;if(this.bytes[this.currentByteIndex]=h,this.nextBit=(this.nextBit+e)%8,this.totalBits+=e,this.nextBit==0&&(this.currentByteIndex++,this.bytes.push(0)),n<0){this.currentByteIndex++,n=8+n;let o=(0|t<<n)&255;this.bytes.push(o)}}serializeToHex(){let t="";for(let e=0;e<this.bytes.length;e++){let i=this.bytes[e];t+="0x"+(i>>>0).toString(16).padStart(2,"0")+", "}return t}outputBits(){let t="";for(let e=0;e<this.bytes.length;e++){let i=this.bytes[e];console.log(e+": "+(i>>>0).toString(2).padStart(8,"0")+" ")}}},it=class{constructor(t){this.data=[],this.currentByteIndex=0,this.nextBit=0,this.totalBits=0;let e=t.split(",").map(i=>i.trim());for(let i=0;i<e.length;i++){let n=parseInt(e[i],16);isNaN(n)||this.data.push(n)}}get eof(){return this.currentByteIndex>=this.data.length}read(t){let e=this.data[this.currentByteIndex],i=this.nextBit,n=8-t,r=(e<<i&255)>>>n;return this.nextBit+t>8&&(this.currentByteIndex++,e=this.data[this.currentByteIndex],n=8-(i-n),r=r|e>>>n),this.nextBit=(this.nextBit+t)%8,this.nextBit==0&&this.currentByteIndex++,this.totalBits+=t,r}};var st={canvas:null,dc:null,fillColor:"#000000",strokeColor:"#9999AA",strokeThickness:20,activeLayer:null,backgroundLayer:null,init:function(){this.canvas=document.getElementById("drawing"),this.textarea=document.getElementById("code"),this.gridSize=document.getElementById("gridsize"),this.letterWidth=document.getElementById("letterwidth"),this.letter=document.getElementById("letter"),this.fontSelect=document.getElementById("font-select"),this.letterSelect=document.getElementById("letter-select"),this.createFont=document.getElementById("create-font"),this.deleteFont=document.getElementById("delete-font"),this.exportFont=document.getElementById("export-font"),this.importFont=document.getElementById("import-font"),this.saveLetter=document.getElementById("save-letter"),this.deleteLetter=document.getElementById("delete-letter"),this.gridSizeValue=13,this.letterWidthValue=13,this.dc=new Q(this.canvas),this.dc.grid=40,this.dc.offset={x:10,y:10},this.dc.snapToGrid=!0,this.dc.backgroundColour="#664499",this.dc.gridColour="rgba(255,255,255,0.1)",this.dc.activeTool=new S(this.dc),this.fonts=m.loadFonts(),this.fonts.length==0&&(this.fonts=this.downloadFactoryFonts()),this.currentFont=null,this.setupFontDropdown(),this.setupLayers();let s="{'?', (const uint8_t[]){ 0x0e, 0x65, 0x88, 0xdc, 0x06, 0xdb, 0x02, 0x8b, 0x3c, 0x6a, 0xcc, 0xad, 0x83, 0x0a, 0x83, 0x06, 0x20, 0x02, 0x09, 0x2a, 0x40, 0xd3, 0x42, 0x33, 0x32, 0xd5, 0x14, 0x94, 0xc7, 0x8a, 0x64, 0x78, 0xa5, 0xc0 }, 34, 13},";this.textarea.value=s,this._updateDrawingFromCode(s),this._setupEventHandlers()},setupLayers:function(s){this.dc.deselectAllShapes();let t=(this.letterWidthValue-1)*this.dc.grid;this.letterWidthLine=new y(t,-10,t,500,"rgba(192, 0, 0, 0.4)",4),this.backgroundLayer=new I([this.letterWidthLine]),this.activeLayer=new I(s||[]),this.dc.shapeLayers=[this.activeLayer,this.backgroundLayer],this.dc.activeLayer=this.activeLayer},_updateDrawingFromCode:function(s){if(s.length>0){let t=m.deserializeLetter(s,this.dc.grid,this.gridSizeValue,this.strokeColor,this.strokeThickness);if(t==null){alert("Unable to parse letter");return}if(this.setupLayers(t.shapes),this.letter.value=t.letter,t.letterWidth){let e=parseInt(t.letterWidth);isNaN(e)||(this.letterWidthValue=e,this.letterWidthLine.startPoint.x=(e-1)*this.dc.grid,this.letterWidthLine.endPoint.x=(e-1)*this.dc.grid)}t.og&&(this.textarea.value=m.serializeLetter(this.letter.value,this.dc.activeLayer.shapes,this.letterWidth.value,this.dc.grid,this.gridSizeValue))}},_setupEventHandlers:function(){let s=this,t=function(i){document.querySelectorAll(".tool").forEach(function(r){r.id==i?r.classList.add("active"):r.classList.remove("active")})},e=function(){s.textarea.value=m.serializeLetter(s.letter.value,s.dc.activeLayer.shapes,s.letterWidth.value,s.dc.grid,s.gridSizeValue)};this.dc.addActiveLayerUpdatedListener(function(){e()}),s.textarea.addEventListener("input",function(i){let n=s.textarea.value;s._updateDrawingFromCode(n)}),s.letterWidth.addEventListener("input",function(i){let n=parseInt(s.letterWidth.value);isNaN(n)||(s.letterWidthValue=n,s.letterWidthLine.startPoint.x=(n-1)*s.dc.grid,s.letterWidthLine.endPoint.x=(n-1)*s.dc.grid,e())}),s.letter.addEventListener("input",function(i){let n=s.letter.value;n.length>1&&(s.letter.value=n.substring(0,1)),e()}),s.gridSize.addEventListener("input",function(i){if(confirm("Are you sure you want to change the grid size?  This will clear the current drawing.")==!1){i.preventDefault(),s.gridSize.value=parseInt(480/s.dc.grid+1);return}s.setupLayers(),s.textarea.value="",s.gridSizeValue=parseInt(s.gridSize.value);let n=920/(s.gridSizeValue-1);document.getElementById("scale-value").innerText=Math.floor(n);let r=parseInt(s.gridSize.value);isNaN(r)||(s.dc.grid=480/(r-1))}),window.addEventListener("keydown",function(i){let n=document.activeElement.tagName.toLowerCase();if(["input","textarea","select"].includes(n))return;let o=i.shiftKey?s.dc.grid:1;switch(i.key){case"ArrowLeft":i.preventDefault(),s.dc.nudgeSelectedShapes({x:-o,y:0});break;case"ArrowUp":i.preventDefault(),s.dc.nudgeSelectedShapes({x:0,y:-o});break;case"ArrowRight":i.preventDefault(),s.dc.nudgeSelectedShapes({x:o,y:0});break;case"ArrowDown":i.preventDefault(),s.dc.nudgeSelectedShapes({x:0,y:o});break;case"L":case"l":i.preventDefault(),s.dc.activeTool=new F(s.dc,{strokeColor:s.strokeColor,strokeThickness:s.strokeThickness},{keepDrawing:!0}),t("l");break;case"B":case"b":i.preventDefault(),s.dc.activeTool=new tt(s.dc,{strokeColor:s.strokeColor,strokeThickness:s.strokeThickness}),t("b");break;case"S":case"s":case" ":i.preventDefault(),s.dc.activeTool=new S(s.dc),t("s");break;case"D":case"d":case"Delete":i.preventDefault(),s.dc.deleteSelectedShapes();break}}),s.createFont.addEventListener("click",function(i){i.preventDefault();let n=prompt("Enter the name of the font");if(n){n=n.trim(),n=n.length>50?n.substring(0,50):n;for(let o=0;o<this.fonts.length;o++)if(this.fonts[o].name==n){alert("Font "+n+" already exists");return}this.fonts.push({name:n,letters:[]}),m.saveFonts(this.fonts);let r=document.createElement("option");r.value=n,r.textContent=n,s.fontSelect.appendChild(r),s.fontSelect.value=n,s.fontSelect.disabled=!1;let h=s.fontSelect.querySelector("option");h&&h.value==="0"&&(s.fontSelect.removeChild(h),h=s.letterSelect.querySelector("option"),h&&h.value==="0"&&(h.textContent="Save a Letter")),s.deleteFont.disabled=!1,s.saveLetter.disabled=!1}}),s.deleteFont.addEventListener("click",function(i){i.preventDefault();let n=s.fontSelect.value;if(n){if(confirm("Are you sure you want to delete the font "+n+"?")==!1)return;let r=m.loadFonts();for(let h=0;h<r.length;h++)if(r[h].name==n){r.splice(h,1);break}if(m.saveFonts(r),s.fontSelect.removeChild(s.fontSelect.querySelector('option[value="'+n+'"]')),s.fontSelect.options.length==0){let h=document.createElement("option");h.value="0",h.textContent="[Create Font First]",s.fontSelect.appendChild(h),s.fontSelect.disabled=!0,s.deleteFont.disabled=!0,s.saveLetter.disabled=!0}else s.fontSelect.value=s.fontSelect.options[0].value}}),s.importFont.addEventListener("click",function(i){M.showModal("import-modal")}),s.exportFont.addEventListener("click",function(i){let n=m.exportFontCode(s.currentFont),r=document.getElementById("export-font-data");r.value=n,M.showModal("export-modal")}),s.fontSelect.addEventListener("change",function(i){i.preventDefault();let n=s.fontSelect.value;n!="0"&&s.loadFont(n)}),s.saveLetter.addEventListener("click",function(i){i.preventDefault();let n=s.letter.value,r=s.textarea.value;if(s.currentFont==null){alert("Please create a font first");return}if(n.length==0){alert("Please enter a letter");return}if(n.length>1){alert("Please enter only one letter");return}let h=null;for(let o=0;o<s.currentFont.letters.length;o++){let a=s.currentFont.letters[o];if(a.letter==n){h=a;break}}if(!h){h={letter:n,code:r},s.currentFont.letters.push(h),s.currentFontLetters.push(n),s.currentFontLetters.sort(),s.letterSelect.innerHTML="";for(let o=0;o<s.currentFontLetters.length;o++){let a=s.currentFontLetters[o],d=document.createElement("option");d.value=a,d.textContent=a,a==h.letter&&(d.selected=!0),s.letterSelect.appendChild(d)}s.letterSelect.disabled=!1,s.deleteLetter.disabled=!1}h.code=r,m.saveFonts(s.fonts)}),s.deleteLetter.addEventListener("click",function(i){if(i.preventDefault(),confirm("Are you sure you want to delete the letter "+s.letterSelect.value+"?")==!1)return;let n=s.letterSelect.value;if(n){let r=-1;for(let h=0;h<s.currentFont.letters.length;h++)if(s.currentFont.letters[h].letter==n){r=h;break}r!=-1&&(s.currentFont.letters.splice(r,1),s.currentFontLetters.splice(r,1),s.letterSelect.removeChild(s.letterSelect.querySelector('option[value="'+n+'"]')),s.deleteLetter.disabled=!0),m.saveFonts(s.fonts)}}),s.letterSelect.addEventListener("change",function(i){i.preventDefault();let n=s.letterSelect.value;if(n){let r="";for(let h=0;h<s.currentFont.letters.length;h++){let o=s.currentFont.letters[h];if(o.letter==n){r=o.code;break}}s.textarea.value=r,s._updateDrawingFromCode(r),s.deleteLetter.disabled=!1}}),document.getElementById("start-import-font").addEventListener("click",function(i){i.preventDefault();let n=document.getElementById("import-font-name").value,r=document.getElementById("import-font-data").value;if(n.length==0){alert("Please enter a name for the font");return}if(r.length==0){alert("Please paste in the font data");return}if(m.importFontFromCode(n,r)==!1)alert("Unable to parse letters from the font data");else{s.fonts=m.loadFonts();let h=document.createElement("option");h.value=n,h.textContent=n,s.fontSelect.appendChild(h),s.fontSelect.value=n,s.fontSelect.disabled=!1,M.hideModal("import-modal")}})},loadFont:function(s){for(let t=0;t<this.fonts.length;t++){let e=this.fonts[t];if(e.name==s){this.currentFont=e,this.currentFontLetters=e.letters.map(n=>n.letter),this.currentFontLetters.sort(),this.letterSelect.innerHTML="";let i=document.createElement("option");i.value="0",this.letterSelect.appendChild(i);for(let n=0;n<this.currentFontLetters.length;n++){let r=this.currentFontLetters[n],h=document.createElement("option");h.value=r,h.textContent=r,this.letterSelect.appendChild(h)}this.letterSelect.disabled=!1,this.saveLetter.disabled=!1;break}}},downloadFactoryFonts:function(){let s=["/curves.json","/original.json"],t=[];for(let e=0;e<s.length;e++){let i=s[e],n=new XMLHttpRequest;if(n.open("GET",i,!1),n.overrideMimeType("application/json"),n.send(null),n.status===200){let r=JSON.parse(n.responseText);t.push(r)}else console.error("Error loading font: "+i)}return m.saveFonts(t),t},setupFontDropdown:function(){for(let s=0;s<this.fonts.length;s++){let t=this.fonts[s],e=document.createElement("option");e.value=t.name,e.textContent=t.name,this.fontSelect.appendChild(e)}this.fonts.length>0&&(this.fontSelect.value=this.fonts[0].name,this.loadFont(this.fonts[0].name),this.fontSelect.disabled=!1,this.deleteFont.disabled=!1,this.exportFont.disabled=!1)}};st.init();})();

)htmljs"